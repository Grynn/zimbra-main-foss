<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlextras" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%--
paramaters:
  offset=...
  query=...
--%>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<zm:computeSearchContext var="context" default="mail" usecache="true"/>
<c:set var="convHit" value="${context.currentItem}"/>

<c:set var="csi" value="${param.csi}"/>
<zm:searchConv var="convSearchResult" conv="${convHit}" context="${context}" markread="true" wanthtml="false" sort="dateAsc"/>
<zm:computeNextPrevItem var="convCursor" searchResult="${context.searchResult}" index="${context.currentItemIndex}"/>

<c:if test="${empty csi}">
	<c:set var="csi" value="${convSearchResult.size-1}"/>
</c:if>
<zm:getMessage var="message" id="${convSearchResult.messageHits[csi].id}" markread="true" wanthtml="true" neuterimages="${empty param.xim}"/>

<app:head title="${convHit.subject}"/>

<body>

<c:url value="clv" var="closeurl">
	<c:param name='so' value='${context.searchResult.offset}'/>
	<c:param name='si' value='${context.currentItemIndex}'/>
	<c:if test="${! empty context}"><c:param name='sc' value='${context.id}'/></c:if>
	<c:if test="${!empty param.sq}"><c:param name='sq' value='${param.sq}'/></c:if>
	<c:if test="${!empty param.sfi}"><c:param name='sfi' value='${param.sfi}'/></c:if>
	<c:if test="${!empty param.sti}"><c:param name='sti' value='${param.sti}'/></c:if>
</c:url>

<c:set var="toolbar">
	<td class='toolbar unread'><nobr><a href="${closeurl}" accesskey="z">&#171; ${fn:escapeXml(context.backTo)}</a></nobr></td>
	<td class='toolbar'><button>Report Spam</button></td>
	<td class='toolbar'><button>Delete</button></td>
	<td class='toolbar'>
		<select>
			<option selected disabled>More actions...</option>
			<option value='read' class='actionOption'>Mark as read</option>
			<option value='unread' class='actionOption'>Mark as unread</option>
			<option value='star' class='actionOption'>Add star</option>
			<option value='unstar' class='actionOption'>Remove star</option>
			<option disabled>--------</option>
			<option disabled>Apply label:</option>
			<zm:forEachTag var="tag">
				<option class='actionOption' value='<c:out value="${tag.id}"/>'><c:out value="${tag.name}"/></option>
			</zm:forEachTag>
			<option class='actionOption' value='new'>New Label...</option>
		</select>
	</td>
	<td width=100%></td>
	<c:if test="${context.hasPrevItem}">
		<zm:prevItemUrl var="prevItemUrl" value="/mail/cv" cursor="${convCursor}" context="${context}"/>
		<td class='toolbar unread'><nobr><a <c:if test="${keys}">accesskey="b"</c:if> href="${prevItemUrl}">&lsaquo; Newer</a></nobr></td>
	</c:if>
	<c:if test="${context.hasNextItem}">
		<zm:nextItemUrl var="nextItemUrl" value="/mail/cv" cursor="${convCursor}" context="${context}"/>
		<td class='toolbar unread'><nobr><a <c:if test="${keys}">accesskey="f"</c:if> href="${nextItemUrl}">Older &rsaquo;</a></nobr></td>
	</c:if>
</c:set>

<zm:getMailbox var="mailbox"/>
<app:view mailbox="${mailbox}">

<div class="niftyMail">
	<b class="rtopNiftyMail">
		<b class="r1"></b>
		<b class="r2"></b>
		<b class="r3"></b>
		<b class="r4"></b>
	</b>
	<div class="inbox" id="inbox">
		<table border=0 cellpadding=0 cellspacing=0 width=100%>
		<tr>
				${toolbar}
		</tr>
		<tr>
			<td colspan=100 class="convContent">
				<table border=0 width=100%><tr>
				<td valign=top colspan=4 width=100%>
					<table border=0 cellpadding=2 cellspacing=2 width=100%>
						<tr>
							<td width=100%>
								<span class="convHeader">${fn:escapeXml(message.subject)}</span>
								<c:set var="tagNames" value="${fn:escapeXml(zm:getTagNames(pageContext, message.tagIds))}"/>
								<span class="labelSmall">${tagNames}</span>
							</td>
						</tr>
					</table>
					<c:forEach items="${convSearchResult.messageHits}" var="mess" varStatus="status">
						<table border=0 cellpadding=0 cellspacing=0>
							<c:if test="${status.first}">
								<tr>
									<td rowspan=2 class="cTopLeft"></td>
									<td class="cTop" colspan=4 height=4></td>
									<td rowspan=2 class="cTopRight"></td>
								</tr>
							</c:if>
							<c:if test="${!status.first}">
								<tr>
									<td rowspan=2 class="cConnector"></td>
									<td class="cTop" colspan=4 height=4></td>
									<td rowspan=2 class="cTopRight"></td>
								</tr>
							</c:if>
							<tr>
								<td class="msgHeaderCell">
									<app:img src="${mess.isFlagged ? 'star_on_sm_2.gif' : 'star_off_2.gif'}" style="cursor:pointer"/>
									<span>${fn:escapeXml(mess.displaySender)}</span>&nbsp;
								</td>
								<td width=100% valign=bottom>
									<c:if test="${status.last}">
										<div class="msgText">
											to ${fn:escapeXml(message.displayTo)}
										</div>
									</c:if>
									<c:if test="${!status.last}">
										<div class="msgFrag">
											<zm:currentResultUrl var="msgUrl" value="cv"  context="${context}" cso="${convSearchResult.offset}" csi="${status.index}"/>
											<a href="${msgUrl}">${fn:escapeXml(empty mess.fragment ? zm:m(pageContext, 'noFragment') : zm:truncate(mess.fragment,100, true))}</a>
										</div>
									</c:if>
								</td>
								<c:if test="${status.last}">
									<td class="msgOptions"><a href="javascript:;">More options</a></td>
								</c:if>
								<c:if test="${!status.last}">
									<td></td>
								</c:if>
								<td class="nowrap" align=right>
									<c:if test="${mess.hasAttachment eq true}">
										&nbsp;<app:img src="paperclip.gif" width='15' height='15' border='0' style="vertical-align:middle"/>
									</c:if>
									<span>${fn:escapeXml(zm:displayMsgDate(pageContext, mess.date))}</span>
								</td>
							</tr>
						</table>
					</c:forEach>
					<div class="cMiddle convTopContent">
						<c:set var="body" value="${message.body}"/>
						<c:if test="${body.contentType eq 'text/html'}">
							${body.content}
						</c:if>
						<c:if test="${!(body.contentType eq 'text/html')}">
							${body.textContentAsHtml}
						</c:if>
						<br><br>
					</div>
					<div class="cMiddle cActionMiddle">
						<span class="msgActionLink"><fmt:message key="reply"/></span>
						<span class="msgActionLink"><fmt:message key="forward"/></span>
						<textarea wrap=soft rows=2 class="msgActionTextArea"></textarea>
					</div>
					<table border=0 cellpadding=0 cellspacing=0 height=8><tr>
						<td class="cBotLeft cGray"></td>
						<td class="cBot cGray"></td>
						<td class="cBotRight cGray"></td>
					</tr></table>
				</td>
				<td valign=top style="padding: 0 25 0 5">
					<div class="sidebarLink"><app:img src="tearoff_icon.gif" width='16' height='16' border='0'/> <a href="javascript:;" style="vertical-align: top">New window</a></div>
					<div class="sidebarLink"><app:img src="print_icon.gif" width='16' height='16' border='0'/> <a href="javascript:;" style="vertical-align: top">Print all</a></div>
					<c:if test="${!(csi eq 0)}">
						<div class="sidebarLink"><app:img src="expand_icon.gif" width='16' height='16' border='0'/> <a href="javascript:;" style="vertical-align: top">Expand all</a></div>
					</c:if>
					<app:ads content="${convHit.subject} ${convHit.subject}"/>
				</td>
				</tr></table>
			</td>
		</tr>
		<tr><td height=5></td></tr>
		<tr>
				${toolbar}
		</tr>
		</table>
	</div>
	<b class="rbottomNiftyMail">
		<b class="r4"></b>
		<b class="r3"></b>
		<b class="r2"></b>
		<b class="r1"></b>
	</b>
</div>
</app:view>
</body>
</html>
