<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.mailapp" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<%--
paramaters:
  offset=...
  query=...
--%>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

<title>Zmail - Conversation Subject Here</title>
<style type="text/css">
	@import url("style/nifty.css");
	@import url("style/common.css");
	@import url("style/mail.css");
</style>
</head>
<body leftmargin=0 rightmargin=0>

<zm:search var="searchResult" limit="25" query="${param.query}" offset="${param.cvoffset}" conv="${param.id}"/>
<c:set value="${empty param.mid ? searchResult.hits[0].id : param.mid}" var="mid"/>
<zm:getMessage var="msg" id="${mid}" markread="true" wanthtml="false" neuterimages="false"/>

<c:set var="toolbar">
							<td class='toolbar unread'><nobr><a href="clv">&#171; Back to Inbox</a></td>
							<td class='toolbar'><button>Report Spam</button></td>
							<td class='toolbar'><button>Delete</button></td>
							<td class='toolbar'>
								<select>
									<option selected disabled>More actions...</option>
									<option name='action' value='read' class='actionOption'>Mark as read</option>
									<option name='action' value='unread' class='actionOption'>Mark as unread</option>
									<option name='action' value='star' class='actionOption'>Add star</option>
									<option name='action' value='unstar' class='actionOption'>Remove star</option>
									<option disabled>--------</option>
									<option disabled>Apply label:</option>
									<zm:forEachTag var="tag">
										<option class='actionOption' value='<c:out value="${tag.id}"/>'><c:out value="${tag.name}"/></option>
									</zm:forEachTag>
									<option class='actionOption' value='new'>New Label...</option>
								</select>
							</td>
							<td width=100%></td>

<%-- NEED SERVER SUPPORT FOR NEXT/PREV CONVERSATION
							<c:if test="${param.offset gt 0}">
								<td class='toolbar'><nobr><a href="clv?offset=${searchResult.previousOffset}">&lt; Newer</a></td>
							</c:if>
							<c:if test="${searchResult.size gt 0}">
								<td class='toolbar' id='paging'><nobr><b>${param.offset+1} - ${param.offset+searchResult.size}</b></td>
							</c:if>
							<c:if test="${searchResult.hasMore}">
								<td class='toolbar'><nobr><a href="clv?offset=${searchResult.nextOffset}">Older &gt;</a></td>
							</c:if>
--%>
</c:set>

<zm:getMailbox var="mailbox"/>

<table border=0 cellpadding=0 cellspacing=0 width=100%>
<tr class="topbar">
	<td class="leftPane" rowspan=2><a href="http://www.zimbra.com" target="_blank"><img src="images/zimbra_logo.gif" width=150 height=50 border=0></a></td>
	<td width=100%></td>
	<td class="username" id="username">${mailbox.name}</td>
	<td class='cellSeparator'>|</td>
	<td class="nowrap"><a href="login?op=options">Settings</a></td>
	<td class='cellSeparator'>|</td>
	<td class="nowrap"><a href="login?op=help">Help</a></td>
	<td class='cellSeparator'>|</td>
	<td class="nowrap"><a href="login?op=logout">Sign out</a></td>
</tr>
<tr>
	<td colspan=100><br>
		<form method="get" action="clv">
		<table border=0 width=100%>
		<tr>
			<td><input id="searchbox" type="text" size=25 maxlen=256 name=query></td>
			<td><input id="searchMailButton" type="submit" name="mail" value="Search Mail"></td>
			<td><input id="searchWebButton" type="submit" name="web" value="Search the Web"></td>
			<td class="searchOptions">
				<a href="javascript:;">Show search options</a><br>
				<a href="javascript:;">Create a filter</a>
			</td>
			<td width=100%></td>
		</tr>
		<tr>
			<td colspan=100 align=middle>
				<div style='width:200px' class="niftyError" id='errorContainer'>
					<b class="rtopNiftyError">
						<b class="r1"></b>
						<b class="r2"></b>
						<b class="r3"></b>
						<b class="r4"></b>
					</b>
					<span id='error' class='error'>
						Error goes here
					</span>
					<b class="rbottomNiftyError">
						<b class="r4"></b>
						<b class="r3"></b>
						<b class="r2"></b>
						<b class="r1"></b>
					</b>
				</div>
			</td>
		</tr>
		</table>
		</form>
	</td>
</tr>
<tr>
	<td valign=top class="leftPane" id="leftPane">
		<b class='folder'><a href="javascript:;">Compose Mail</a></b><p>

		<div class="folder folderSelected<c:if test="${mailbox.inbox.hasUnread}"> unread</c:if><c:if test="${mailbox.inbox.id eq selected}"> folderSelected</c:if>">
			<a href='${empty base ? "clv" : base}?query=in:"${mailbox.inbox.pathUrlEncoded}"'>
				${fn:escapeXml(empty label ? mailbox.inbox.name : label)} <c:if test="${mailbox.inbox.hasUnread}"> (${mailbox.inbox.unreadCount}) </c:if>
			</a>
		</div>
		<div class="folder<c:if test="${mailbox.sent.hasUnread}"> unread</c:if><c:if test="${mailbox.sent.id eq selected}"> folderSelected</c:if>">
			<a href='${empty base ? "clv" : base}?query=in:"${mailbox.sent.pathUrlEncoded}"'>
				${fn:escapeXml(empty label ? mailbox.sent.name : label)} <c:if test="${mailbox.sent.hasUnread}"> (${mailbox.sent.unreadCount}) </c:if>
			</a>
		</div>
		<div class="folder<c:if test="${mailbox.drafts.hasUnread}"> unread</c:if><c:if test="${mailbox.drafts.id eq selected}"> folderSelected</c:if>">
			<a href='${empty base ? "clv" : base}?query=in:"${mailbox.drafts.pathUrlEncoded}"'>
				${fn:escapeXml(empty label ? mailbox.drafts.name : label)} <c:if test="${mailbox.drafts.hasUnread}"> (${mailbox.drafts.unreadCount}) </c:if>
			</a>
		</div>
		<div class="folder<c:if test="${mailbox.spam.hasUnread}"> unread</c:if><c:if test="${mailbox.spam.id eq selected}"> folderSelected</c:if>">
			<a href='${empty base ? "clv" : base}?query=in:"${mailbox.spam.pathUrlEncoded}"'>
				${fn:escapeXml(empty label ? mailbox.spam.name : label)} <c:if test="${mailbox.spam.hasUnread}"> (${mailbox.spam.unreadCount}) </c:if>
			</a>
		</div>
		<div class="folder<c:if test="${mailbox.trash.hasUnread}"> unread</c:if><c:if test="${mailbox.trash.id eq selected}"> folderSelected</c:if>">
			<a href='${empty base ? "clv" : base}?query=in:"${mailbox.trash.pathUrlEncoded}"'>
				${fn:escapeXml(empty label ? mailbox.trash.name : label)} <c:if test="${mailbox.trash.hasUnread}"> (${mailbox.trash.unreadCount}) </c:if>
			</a>
		</div>
		<p>
		<zm:forEachFolder var="folder">
		<c:if test="${!folder.isSystemFolder and (folder.isNullView or folder.isMessageView or folder.isConversationView)}">
			<c:if test="${!folder.isSearchFolder}">
				<c:if test="${!empty label}"><fmt:message key="${label}" var="label"/></c:if>
				<div class="folder<c:if test="${folder.hasUnread}"> unread</c:if><c:if test="${folder.id eq selected}"> folderSelected</c:if>" style='padding-left: ${4+folder.depth*8}px'>
					<a href='${empty base ? "clv" : base}?query=in:"${folder.pathUrlEncoded}"'>
						${fn:escapeXml(empty label ? folder.name : label)} <c:if test="${folder.hasUnread}"> (${folder.unreadCount}) </c:if>
					</a>
				</div>
			</c:if>
		</c:if>
		</zm:forEachFolder>     
		<p>
		<div class='folder'><a href="contacts">Contacts</a></div><p>
		<div style='width:140px' class="niftyLabel">
			<b class="rtopNiftyLabel">
				<b class="r1"></b>
				<b class="r2"></b>
				<b class="r3"></b>
				<b class="r4"></b>
			</b>
			<span style='cursor:pointer;'>
				&nbsp;<img src="images/opentriangle.gif" width=11 height=11> <fmt:message key="searches"/><br>
				<table border=0 cellpadding=3 cellspacing=0 width=100%>
				<tr><td>
					<table border=0 cellpadding=2 cellspacing=2 width=100% bgcolor="#FFFFFF"><tr><td>
						<zm:forEachFolder var="folder">
							<c:if test="${folder.isSearchFolder and (folder.depth eq 0)}">
								<c:if test="${!empty label}"><fmt:message key="${label}" var="label"/></c:if>
								<div class='labelContent'>
									<a href='clv?query=${fn:escapeXml(folder.query)}'>
										${fn:escapeXml(empty label ? folder.name : label)}
									</a>
								</div>
							</c:if>
						</zm:forEachFolder>
					</td></tr></table>
				</td></tr>
				</table>
			</span>
			<b class="rbottomNiftyLabel">
				<b class="r4"></b>
				<b class="r3"></b>
				<b class="r2"></b>
				<b class="r1"></b>
			</b>
		</div><p>
		<div style='width:140px' class="niftyLabel">
			<b class="rtopNiftyLabel">
				<b class="r1"></b>
				<b class="r2"></b>
				<b class="r3"></b>
				<b class="r4"></b>
			</b>
			<span style='cursor:pointer;'>
				&nbsp;<img src="images/opentriangle.gif" width=11 height=11> Labels<br>
				<table border=0 cellpadding=3 cellspacing=0 width=100%>
				<tr><td>
					<table border=0 cellpadding=2 cellspacing=2 width=100% bgcolor="#FFFFFF"><tr><td>
						<zm:forEachTag var="tag">
							<div class='labelContent ${tag.hasUnread ? ' unread' : ''}'>
								<a href='clv?query=tag:"${fn:escapeXml(tag.name)}"'/>
									<c:out value="${tag.name}"/>
									<c:if test="${tag.hasUnread}"> (${tag.unreadCount}) </c:if>
								</a>
							</div>
						</zm:forEachTag>
					</td></tr></table>
					<div class="labelContent labelEdit"><a href="javascript:;">Edit labels</a></div>
				</td></tr>
				</table>
			</span>
			<b class="rbottomNiftyLabel">
				<b class="r4"></b>
				<b class="r3"></b>
				<b class="r2"></b>
				<b class="r1"></b>
			</b>
		</div>
	</td>
	<td valign=top colspan=100>
		<table border=0 cellpadding=0 cellspacing=0 width=100%>
		<tr>
			<td id="rightPane">
				<div class="niftyMail">
					<b class="rtopNiftyMail">
						<b class="r1"></b>
						<b class="r2"></b>
						<b class="r3"></b>
						<b class="r4"></b>
					</b>
					<div class="inbox" id="inbox">
						<table border=0 cellpadding=0 cellspacing=0 width=100%>
						<tr>
							${toolbar}
						</tr>
						<tr>
							<td colspan=100 class="convContent">
								<table border=0 cellpadding=2 cellspacing=2 width=100%>
								<tr>
									<td width=100%>
										<span class="convHeader">${fn:escapeXml(msg.subject)}</span>
										<c:set var="tagNames" value="${fn:escapeXml(zm:getTagNames(pageContext, msg.tagIds))}"/>
										<span class="labelSmall">${tagNames}</span>
									</td>
									<td class="nowrap" valign=top>
										<img src="images/tearoff_icon.gif" width=16 height=16 border=0 style="vertical-align:middle"> <a href="javascript:;">New window</a>
										&nbsp;&nbsp;
										<img src="images/print_icon.gif" width=16 height=16 border=0 style="vertical-align:middle"> <a href="javascript:;">Print all</a>
									</td>
								</tr>
								</table>
								<c:forEach items="${searchResult.hits}" var="mess" varStatus="status">
								<table border=0 cellpadding=0 cellspacing=0>
									<c:if test="${status.first}">
										<tr>
											<td rowspan=2 class="cTopLeft"></td>
											<td class="cTop" colspan=4 height=4></td>
											<td rowspan=2 class="cTopRight"></td>
										</tr>
									</c:if>
									<c:if test="${!status.first}">
										<tr>
											<td rowspan=2 class="cConnector"></td>
											<td class="cTop" colspan=4 height=4></td>
											<td rowspan=2 class="cTopRight"></td>
										</tr>
									</c:if>
									<tr>
										<td class="msgHeaderCell">
											<img src='images/${mess.isFlagged ? 'star_on_sm_2.gif' : 'star_off_2.gif'}' style="cursor:pointer">&nbsp;
											<span>${fn:escapeXml(mess.displaySender)}</span>&nbsp;
										</td>
										<td width=100% valign=bottom>
											<c:if test="${status.last}">
												<table border=0 cellpadding=0 cellspacing=0 class="msgFragContainer">
												<tr><td class="msgText">
													to
												</td></tr>
												</table>
											</c:if>
											<c:if test="${!status.last}">
												<table border=0 cellpadding=0 cellspacing=0 class="msgFragContainer">
												<tr><td class="msgText">
													<div style="white-space:nowrap; overflow:hidden"><span class="msgFrag">
														<c:url value="cv" var="url">
															<c:param name="id" value="${param.id}"/>
															<c:param name="query" value="${param.query}"/>
															<c:param name="offset" value="${param.offset}"/>
															<c:param name="cvoffset" value="${param.cvoffset}"/>
															<c:param name="mid" value="${mess.id}"/>
														</c:url>
														<a href="${url}">${fn:escapeXml(empty mess.fragment ? zm:m(pageContext, 'noFragment') : zm:truncate(mess.fragment,100, true))}</a>
													</span></div>
												</td></tr>
												</table>
											</c:if>
										</td>
										<c:if test="${status.last}">
											<td class="msgOptions"><a href="javascript:;">More options</a></td>
										</c:if>
										<c:if test="${!status.last}">
											<td></td>
										</c:if>
										<td class="msgText" align=right>
											<c:if test="${mess.hasAttachment eq true}">
												&nbsp;<img src="images/paperclip.gif" width=15 height=15 border=0 style="vertical-align:middle">
											</c:if>
											<span>${fn:escapeXml(zm:displayMsgDate(pageContext, mess.date))}</span>
										</td>
									</tr>
								</table>
								</c:forEach>
								<div class="cMiddle convTopContent">${msg.displayBodyHtml}</div>
								<div class="cMiddle convBotContent">
<%--
								<form action="" method="post" onsubmit="return false" enctype="multipart/form-data" accept-charset="utf-8" class="cActionMiddle">
									<table border=0 width=100% cellpadding=0 cellspacing=0 class="msgActionContainer">
									<tr><td></td></tr>
									</table>
								</form>
--%>
								</div>
								<table border=0 cellpadding=0 cellspacing=0 height=8><tr>
									<td class="cBotLeft"></td>
									<td class="cBot"></td>
									<td class="cBotRight"></td>
								</tr></table>
							</td>
						</tr>
						<tr><td height=5></td></tr>
						<tr>
							${toolbar}
						</tr>
						</table>
					</div>
					<b class="rbottomNiftyMail">
						<b class="r4"></b>
						<b class="r3"></b>
						<b class="r2"></b>
						<b class="r1"></b>
					</b>
				</div>
			</td>
		</tr>
		<tr><td><br></td></tr>
		<tr>
			<td class="quota" id="quota">
				<c:set var="max" value="${mailbox.attrs.zimbraMailQuota[0]}"/>
				You are currently using ${zm:displaySize(mailbox.size)} of ${max==0 ? zm:m(pageContext, 'unlimited') : zm:displaySize(max)}.
			</td>
		</tr>
		<tr>
			<td class="footer footer-small">
				<a href="http://www.zimbra.com/privacy.html" target="_blank">Privacy Policy</a> - 
				<a href="http://www.zimbra.com/license/" target="_blank">License</a> - 
				<a href="http://www.zimbra.com/legal.html" target="_blank">Trademarks</a><br>
				&copy; 2006 Zimbra Inc.
			</td>
		</tr>
		</table>
	</td>
	<td>&nbsp;</td>
</tr>
</table>

</body>
</html>
