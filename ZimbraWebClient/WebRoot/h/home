<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<fmt:setBundle basename="/messages/ZhMsg" scope="session"/>

<app:handleError>
<zm:computeSearchContext var="context" usecache="true"/>
<zm:getMailbox var="mailbox"/>
<app:composeCheck/>
<c:set var="action" value="${empty param.paction ? param.action : param.paction}" scope="request"/>
<c:if test="${not empty param.expand}">
    <c:set target="${sessionScope.expanded}" property="${param.expand}" value="expand"/>
</c:if>
<c:if test="${not empty param.collapse}">
    <c:set target="${sessionScope.expanded}" property="${param.collapse}" value="collapse"/>
</c:if>
</app:handleError>

<c:if test="${param.mesg eq 'welcome'}">
<app:status style="info">
    <fmt:message key="htmlWelcomeMesg"/>
</app:status>
</c:if>

<c:set var="fullname" value="${fn:escapeXml(mailbox.defaultIdentity.fromDisplay)}"/>            
<c:set var="folder" value="${mailbox.inbox}"/>
<fmt:message key="inbox" var="label"/>
<c:url var="url" value="/h/${empty base ? 'search' : base}">
<c:param name="sfi" value="${folder.id}"/>
</c:url>
<app:handleError>
<zm:computeSearchContext var="context" usecache="true"/>
    <fmt:message var="unknownRecipient" key="unknownRecipient"/>
    <fmt:message var="noSubject" key="noSubject"/>
</app:handleError>

<c:set var="selected" value="${empty param.selected ? 'home' : param.selected}"/>
<app:view mailbox="${mailbox}" title="${fn:escapeXml(empty label ? folder.name : label)} ( ${folder.unreadCount})" context="${context}" selected='home' folders="true" tags="true" searches="true" keys="true">

<table width="100%" cellpadding="0" cellspacing="0" >
<tr>
    <td class='TbTop'>${toolbar}</td>
</tr>
<tr>
<td class='ZhAppContent' style="padding:7px;width:100%;height:100%;valign:top;">
        <h1 style="border-bottom: 3px solid #666666; padding-bottom: 2px; font-size: 20px">Hi! ${empty fullname ? mailbox.name : fullname} &nbsp; 

        <span>
            <a style="font-size:13px;color:#666666; font-style: normal;" href='${url}'>${fn:escapeXml(empty label ? folder.name : label)}
                <c:if test="${folder.hasUnread}">&nbsp;(${folder.unreadCount}) </c:if>
            </a>
        </span>
       </h1>

<table width="100%" border="0" cellpadding="8" cellspacing="0">
<tr>
    <td width="50%">
        <table cellpadding="5" cellspacing="0" border='0' width='100%'>
            <tr>
                <td>
                    <h2 style="margin: 0px; padding-bottom: 2px;border-bottom: 2px solid #CCCCCC; font-size: 16px;">Mail</h2>
                </td>
            </tr>
            <c:if test="${context.isMessageSearch}">
                <c:forEach items="${context.searchResult.hits}" var="hit" varStatus="status" begin="0" end="4">
                    <tr>
                        <zm:currentResultUrl var="convUrl" value="search" cid="${hit.id}" action='view' index="${status.index}" context="${context}" usecache="true"/>
                        <td style="border-bottom:1px solid #ccc;padding:5px;"  ><p><a style="text-decoration:none;"  href="${convUrl}"><b>${fn:escapeXml(empty hit.messageHit.displaySender ? unknownRecipient :  hit.messageHit.displaySender)}</b></a><br>
                        <a style="color:#000;text-decoration:none;" href="${convUrl}">
                            <c:set var='subj' value="${empty hit.messageHit.subject ? noSubject : zm:truncate(hit.messageHit.subject,80,true)}"/>
                            <c:out value="${subj}"/></a>
                        </p></td>
                    </tr>
                </c:forEach>
            </c:if>
            <c:if test="${context.isConversationSearch}">
                <c:forEach items="${context.searchResult.hits}" var="hit" varStatus="status" begin="0" end="4">
                    <tr>
                        <zm:currentResultUrl var="convUrl" value="search" cid="${hit.id}" action='view' index="${status.index}" context="${context}" usecache="true"/>
                        <td style="border-bottom:1px solid #ccc;padding:5px;width:25%;"><p><a style="text-decoration:none;"  href="${convUrl}">${fn:escapeXml(empty hit.conversationHit.displayRecipients ? unknownRecipient :  hit.conversationHit.displayRecipients)}</a><br>
                        <a style="color:#000;text-decoration:none;" href="${convUrl}">
                            <c:set var='subj' value="${empty hit.conversationHit.subject ? noSubject : zm:truncate(hit.conversationHit.subject,80,true)}"/>
                            <c:out value="${subj}"/></a>
                        </p></td>
                    </tr>
                </c:forEach>
            </c:if>

        </table>
    </td>
    <td valign="top">
        <c:set var="tz" value="${mailbox.prefs.timeZone}" scope="request"/>
        <c:set scope="request" var="dateContext" value="${zm:getToday(tz)}"/>
        <app:apptGadget timezone="${tz}" date="${dateContext}" />
    </td>
</tr>
</table>
</td>
</tr>
</table>

</app:view>
        
