<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>


<app:handleError>
<c:choose>
<c:when test="${not empty mailbox.prefs.locale}">
    <fmt:setLocale value='${mailbox.prefs.locale}' scope='request' />
</c:when>
<c:otherwise>
    <fmt:setLocale value='${pageContext.request.locale}' scope='request' />
</c:otherwise>
</c:choose>
<fmt:setBundle basename="/messages/ZhMsg" scope="session"/>

<zm:computeSearchContext var="context" usecache="true"/>
<zm:getMailbox var="mailbox"/>
<app:composeCheck/>
<c:set var="action" value="${empty param.paction ? param.action : param.paction}" scope="request"/>
<c:if test="${not empty param.expand}">
    <c:set target="${sessionScope.expanded}" property="${param.expand}" value="expand"/>
</c:if>
<c:if test="${not empty param.collapse}">
    <c:set target="${sessionScope.expanded}" property="${param.collapse}" value="collapse"/>
</c:if>
</app:handleError>

<c:if test="${param.mesg eq 'welcome'}">
<app:status style="info" html="true">
    <fmt:message key="htmlWelcomeMesg"/>
</app:status>
</c:if>

<c:set var="fullname" value="${fn:escapeXml(mailbox.defaultIdentity.fromDisplay)}"/>            
<c:set var="folder" value="${mailbox.inbox}"/>
<fmt:message key="inbox" var="label"/>
<c:url var="url" value="/h/${empty base ? 'search' : base}">
<c:param name="sfi" value="${folder.id}"/>
</c:url>
<app:handleError>
<zm:computeSearchContext var="context" usecache="true"/>
    <fmt:message var="unknownRecipient" key="unknownRecipient"/>
    <fmt:message var="noSubject" key="noSubject"/>
</app:handleError>

<c:set var="selected" value="${empty param.selected ? 'home' : param.selected}"/>
<app:view mailbox="${mailbox}" title="${fn:escapeXml(empty label ? folder.name : label)} ( ${folder.unreadCount})" context="${context}" selected='home' folders="true" tags="true" searches="true" keys="true">

<table width="100%" cellpadding="0" cellspacing="0" >
<tr>
    <td class='TbTop'>${toolbar}</td>
</tr>
<tr>
<td class='ZhAppContent' style="padding:7px;width:100%;height:100%;valign:top;">       
       <span class="HelloGreeting">Hi! ${empty fullname ? mailbox.name : fullname} &nbsp;
         <span>
             <a style="font-size:13px;color:#666666; font-style: normal; text-decoration: none;" href='${url}'>${fn:escapeXml(empty label ? folder.name : label)}
                 <c:if test="${folder.hasUnread}">&nbsp;(${folder.unreadCount}) </c:if>
             </a>
         </span>
<br><br>
<table width="100%" border="0" cellpadding="8" cellspacing="0">
<tr>
    <td valign="top" width="50%">
        <table cellpadding="0" cellspacing="0" border='0' width='100%'>
            <tr>
                <td>
                     <table border="0" cellpadding="0" cellspacing="0" width="100%">
        				<tr>
       						 <td class="ImgAccountsHeader_L"></td>
       						 <td class="ImgAccountsHeader__H AccountsHeader">Mail </td>
       						 <td class="ImgAccountsHeader_R"></td>
				        </tr>
				       </table>
                </td>
            </tr>
            <c:if test="${context.isMessageSearch}">
                <c:forEach items="${context.searchResult.hits}" var="hit" varStatus="status" begin="0" end="4">
                    <tr class="ZhHomeRow">
                        <zm:currentResultUrl var="convUrl" value="search" cid="${hit.id}" action='view' index="${status.index}" context="${context}" usecache="true"/>
                        <td  class="ZhHomeCell"><p><a style="text-decoration:none;"  href="${convUrl}"><b>${fn:escapeXml(empty hit.messageHit.displaySender ? unknownRecipient :  hit.messageHit.displaySender)}</b></a><br>
                        <a class="ZhHomeTextLink" href="${convUrl}">
                            <c:set var='subj' value="${empty hit.messageHit.subject ? noSubject : zm:truncate(hit.messageHit.subject,80,true)}"/>
                            <c:out value="${subj}"/></a>
                        </p></td>
                    </tr>
                </c:forEach>
            </c:if>
            <c:if test="${context.isConversationSearch}">
                <c:forEach items="${context.searchResult.hits}" var="hit" varStatus="status" begin="0" end="4">
                    <tr class="ZhHomeRow">
                        <zm:currentResultUrl var="convUrl" value="search" cid="${hit.id}" action='view' index="${status.index}" context="${context}" usecache="true"/>
                        <td class="ZhHomeCell" style="width:25%;"><p><a style="text-decoration:none;"  href="${convUrl}">${fn:escapeXml(empty hit.conversationHit.displayRecipients ? unknownRecipient :  hit.conversationHit.displayRecipients)}</a><br>
                        <a class="ZhHomeTextLink" href="${convUrl}">
                            <c:set var='subj' value="${empty hit.conversationHit.subject ? noSubject : zm:truncate(hit.conversationHit.subject,80,true)}"/>
                            <c:out value="${subj}"/></a>
                        </p></td>
                    </tr>
                </c:forEach>
            </c:if>

        </table>
    </td>
    <td valign="top" width="50%">
		<c:choose>
			<c:when test="${mailbox.features.calendar}">
				<c:set var="tz" value="${mailbox.prefs.timeZone}" scope="request"/>
				<c:set scope="request" var="dateContext" value="${zm:getToday(tz)}"/>
				<app:apptGadget timezone="${tz}" date="${dateContext}" />
			</c:when>
			<c:otherwise>
				<c:if test="${mailbox.features.voice}">
					<table cellpadding="0" cellspacing="0" border='0' width='100%'>
						<tr><td>
							<table border="0" cellpadding="0" cellspacing="0" width="100%">
								<tr>
									<td class="ImgVoiceAccountsHeader_L"></td>
									<td class="ImgVoiceAccountsHeader__H AccountsHeader">
										Voice Mail
									</td>
									<td class="ImgVoiceAccountsHeader_R"></td>
								</tr>
							</table>
						</td></tr>
						<tr><td class="ZhHomeVoiceCell">
							<%--
							Going with the theory that voice access is really really slow, we put
							the voice account summary in an iframe to speed up home page loading
							--%> 
							<iframe class="ZhHomeVoiceIframe" scrolling="auto" marginWidth="0" marginHeight="0" frameBorder="0" src="/h/homevoice"></iframe>
						</td>
						</tr>
					</table>
				</c:if>
			</c:otherwise>
		</c:choose>
    </td>
	<c:set var="comcast_msgcenterad" value="false"/>
		<c:forEach var="zimlets" items="${mailbox.attrs.zimbraZimletAvailableZimlets}">
		    <c:if test="${zimlets eq 'comcast_msgcenterad'}">
	        <c:set var="comcast_msgcenterad" value="true"/>    
		</c:if>
		</c:forEach>
		<c:if test="${comcast_msgcenterad}">
		<td rowspan="2">
			<iframe src="http://pn2.adserver.yahoo.com/a?f=2022363872&pn=comcast&p=com-mail&l=LREC&c=sh&bg=ffffff&no_expandable=1"
	              marginwidth="0"
	              marginheight="0"
	              width="300"
	              height="264"
	              border="0"
	              frameborder="0"
	              style="border:none;"
	              scrolling="no" align="center"></iframe>
			</td>
		</c:if>
</tr>
</table>
</td>
</tr>
</table>

</app:view>
        
