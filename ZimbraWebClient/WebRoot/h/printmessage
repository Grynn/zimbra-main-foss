<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="com.zimbra.i18n" %>
<app:handleError>
<zm:getMailbox var="mailbox"/>
<c:set var="skin" value="${not empty param.skin ? param.skin : (not empty sessionScope.skin ? sessionScope.skin : mailbox.prefs.skin)}"/>
<c:choose>
	<c:when test="${not empty mailbox.prefs.locale}">
		<fmt:setLocale value='${mailbox.prefs.locale}' scope='request' />
	</c:when>
	<c:otherwise>
		<fmt:setLocale value='${pageContext.request.locale}' scope='request' />
	</c:otherwise>
</c:choose>
<fmt:setBundle basename="/messages/ZhMsg" scope="request"/>
<c:set var="messageIds" value="${fn:join(paramValues.id, ',')}"/>
</app:handleError>
<html>
<app:head mailbox="${mailbox}"/>
<body style='background:white;'>
<div class='ZhCallListPrintView'>
<table cellpadding="0" cellspacing="5"  width="100%">
	<tr>
		<td class='ZhZimbraTitle'><fmt:message key="zimbraTitle"/></td>
		<td nowrap width='1%'><b>${fn:escapeXml(mailbox.name)}</b></td>
	</tr>
</table>
<div align="right"><a style="font-size:12px;" href="javascript:increaseFontSize();">+</a> Font size <a href="javascript:decreaseFontSize();" style="font-size:12px;">-</a></div>
<hr/>
<div id="zPrintMsg" class="zPrintMsgs11">
<c:forEach items="${messageIds}" var="mid" varStatus="status">
<c:set var="cid" value="${fn:split(mid,':')}"/>
<c:if test="${cid[0] eq 'C'}">
    <zm:computeSearchContext var="context" usecache="true" types="conversation" query="*"/>
    <c:if test="${fn:length(cid) gt 2}"><c:set var="cidExt" value=":${cid[2]}"/></c:if> <%-- there are two colons when conv is from shared folder so we need to form correct cid as sharedFolderId:convId --%>
    <zm:searchConv var="convSearchResult" id="${cid[1]}${cidExt}" context="${context}"  markread="false" fetch="all"/>
    <table cellpadding="0" cellspacing="5"  width="100%">
        <tr>
            <td>
                <div style="padding: 10px; font-size: 20px !important; font-weight: bold;">${convSearchResult.hits[0].subject}</div><hr/>
            </td>
        </tr>
        <tr>
            <td>
                <c:forEach items="${convSearchResult.hits}" var="hit" varStatus="status">
                    <zm:getMessage var="message" id="${hit.id}" markread="false" neuterimages="${empty param.xim}" />
                    <c:url value="/h/printmessage" var="extImageUrl">
                        <c:param name="id" value="${param.id}"/>
                        <c:param name="xim" value="1"/>
                    </c:url>
                    <app:messagePrintView mailbox="${mailbox}" externalImageUrl="${extImageUrl}" message="${message}" />
                </c:forEach>
            </td>
        </tr>
    </table>
</c:if>
<c:if test="${cid[0] != 'C'}">
    <zm:getMessage var="message" id="${mid}" markread="false" neuterimages="${empty param.xim}" part="${param.part}" />
	<table cellpadding="0" cellspacing="5"  width="100%">
    <tr>
		<td colspan="2">
			<div style="padding: 10px; font-size: 20px !important; font-weight: bold;">${zm:cook(message.subject)}</div><hr/>
		</td>
	</tr>
	<tr>
		<td colspan="2">
            <c:url value="/h/printmessage" var="extImageUrl">
                <c:param name="id" value="${param.id}"/>
                <c:param name="xim" value="1"/>
            </c:url>
			<app:messagePrintView mailbox="${mailbox}" externalImageUrl="${extImageUrl}" message="${message}" />
		</td>
	</tr>
    </table>    
</c:if>    
</c:forEach>
</div>
<c:if test="${empty messageIds}">
	<div class='NoResults'><fmt:message key="noResultsFound"/></div>
</c:if>
<style type="text/css">
    .zPrintMsgs11 *{
        font-family:Tahoma,Arial,Helvetica,sans-serif;
        font-size:11px !important;
    }
    .zPrintMsgs13 *{
        font-family:Tahoma,Arial,Helvetica,sans-serif;
        font-size:13px !important;
    }
    .zPrintMsgs15 *{
        font-family:Tahoma,Arial,Helvetica,sans-serif;
        font-size:15px !important;
    }
    .zPrintMsgs17 *{
        font-family:Tahoma,Arial,Helvetica,sans-serif;
        font-size:17px !important;
    }
    .zPrintMsgs19 *{
        font-family:Tahoma,Arial,Helvetica,sans-serif;
        font-size:19px !important;
    }
</style>
<script type="text/javascript">
    <!--
    window.print();

    var min=11;
    var max=19;
    function increaseFontSize() {
        var p = document.getElementById('zPrintMsg');
        if(p.className) {
            var s = parseInt(p.className.replace("zPrintMsgs",""));
        } else {
            var s = 11;
        }
        if(s!=max) {
            s += 2;
        }
        p.className = "zPrintMsgs"+s;
    }
    function decreaseFontSize() {
        var p = document.getElementById('zPrintMsg');
        if(p.className) {
            var s = parseInt(p.className.replace("zPrintMsgs",""));
        } else {
            var s = 13;
        }
        if(s!=min) {
            s -= 2;
        }
        p.className = "zPrintMsgs"+s;
    }
    // -->
</script>

</body>
</html>
