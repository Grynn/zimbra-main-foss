<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<fmt:setBundle basename="/msgs/ZhMsg" scope="session"/>
<app:handleError>
    <zm:getMailbox var="mailbox"/>
    <fmt:message var="title" key="newAppointment"/>
    <zm:composeUploader var="uploader"/>
    <c:set var="compose" value="${uploader.compose}"/>
</app:handleError>

<app:handleError>
    <c:choose>
        <c:when test="${not empty param.id or not empty compose.draftId or not empty requestScope.draftid}">
            <c:choose>
                <c:when test="${not empty compose.draftId or not empty requestScope.draftid}">
                    <zm:getMessage var="message" id="${empty requestScope.draftid ? compose.draftId : requestScope.draftid}" wanthtml="${false}"/>
                </c:when>
                <c:otherwise>
                    <zm:getMessage var="message" id="${param.id}" part="${param.part}" wanthtml="${false}"/>
                </c:otherwise>
            </c:choose>
        </c:when>
        <c:otherwise>
            <c:set var="message" value="${null}"/>
        </c:otherwise>
    </c:choose>

    <c:choose>
        <c:when test="${empty compose }">
            <zm:messageCompose var="compose" message="${message}" action="newappt" date="${requestScope.dateContext}"/>
        </c:when>
        <c:when test="${uploader.isUpload and !empty message}">
            <zm:fixupMessageCompose message="${message}" compose="${compose}" newattachments="${uploader.compose.hasFileItems}"/>
        </c:when>
    </c:choose>

</app:handleError>


<app:view title="${not empty compose.subject ? compose.subject : title}" selected='calendar' calendars="true" minical="true" context="${null}" keys="false" date="${requestScope.dateContext}">
    <c:set var="toolbar">
        <table width=100% cellspacing=0 cellpadding=0>
            <tr valign='middle'>
                <td>
                    <table cellspacing=2 cellpadding=0 class='Tb'>
                        <tr>
                            <app:button name="actionSave" src="common/Save.gif" tooltip="save" text="save"/>
                            <td><div class='vertSep'></div></td>
                            <app:button name="actionCancel" src="common/Cancel.gif" tooltip="cancel" text="cancel"/>
                            <td><div class='vertSep'></div></td>
                            <app:button name="actionAttachAdd" src="common/Attachment.gif" tooltip="addAttachments" text="addAttachments"/>
                            <c:if test="${mailbox.features.contacts or mailbox.features.gal}">
                                <td><div class='vertSep'></div></td>
                                <app:button name="actionContactAdd" src="contacts/ContactsPicker.gif" tooltip="addFromContacts" text="addFromContacts"/>
                            </c:if>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </c:set>

    <form action="" method="post" enctype="multipart/form-data" accept-charset="utf-8">
        <table width=100% cellpadding="0" cellspacing="0">
            <tr>
                <td class='TbTop'>
                    ${toolbar}
                </td>
            </tr>
            <tr>
                <td class='ZhAppContent'>
                    <table cellpadding=2 cellspacing=0 width=100% class='Compose'>
                        <tr>
                            <td colspan=2>
                                <table width=100% cellspacing=0 cellpadding=0>
                                    <tr class='contactHeaderRow'>
                                        <td width=20><center><app:img src="calendar/NewAppointment.gif" altkey="ALT_NEW_APPOINTMENT"/></center></td>
                                        <td class='contactHeader'>
                                            <fmt:message key="newAppointment"/>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                        <td colspan=2>
                            <table cellpadding=2 cellspacing=0 width=100%>
                                <tr>
                                    <td valign='top' width=50%>
                                        <fieldset>
                                            <legend><fmt:message key="details"/></legend>
                                            <table cellpadding="5" cellspacing="0">
                                                <tr>
                                                    <td width="1%" align="right"><fmt:message key="subject"/>:</td>
                                                    <td><input style="width:99%" type="text" size="100" name="subject" value="${fn:escapeXml(compose.subject)}"></td>
                                                </tr>
                                                <tr>
                                                    <td width="1%" align="right"><fmt:message key="location"/>:</td>
                                                    <td><input style="width:99%" type="text" size="100" name="location" value="${fn:escapeXml(compose.location)}"></td>
                                                </tr>
                                                <tr>
                                                    <td width="1%" align="right"><fmt:message key="showAs"/>:</td>
                                                    <td>
                                                        <select name="freeBusyStatus">
                                                            <option <c:if test="${compose.freeBusyStatus eq 'F'}">selected </c:if>value="F"><fmt:message key="free"/>
                                                            <option <c:if test="${compose.freeBusyStatus eq 'T'}">selected </c:if> value="T"><fmt:message key="tentative"/>
                                                            <option <c:if test="${compose.freeBusyStatus eq 'B'}">selected </c:if> value="B"><fmt:message key="busy"/>
                                                            <option <c:if test="${compose.freeBusyStatus eq 'O'}">selected </c:if> value="O"><fmt:message key="outOfOffice"/>
                                                        </select>
                                                    </td>
                                                </tr>

                                                <c:set var="numCalendars" value="0"/>
                                                <zm:forEachFolder var="folder">
                                                    <c:if test="${folder.isAppointmentView}">
                                                        <c:set var="numCalendars" value="${numCalendars+1}"/>
                                                    </c:if>
                                                </zm:forEachFolder>
                                                <c:choose>
                                                    <c:when test="${numCalendars gt 1}">
                                                        <tr>
                                                            <td width="1%" align="right"><fmt:message key="calendar"/>:</td>
                                                            <td>
                                                                <select name='appointmentFolder'>
                                                                    <zm:forEachFolder var="folder">
                                                                        <c:if test="${folder.isAppointmentView}">
                                                                            <option value="${folder.id}" />
                                                                            ${fn:escapeXml(zm:getFolderName(pageContext, folder.id))}
                                                                        </c:if>
                                                                    </zm:forEachFolder>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    </c:when>
                                                    <c:otherwise>
                                                        <tr>
                                                            <td colspan=2>&nbsp;</td>
                                                        </tr>
                                                    </c:otherwise>
                                                </c:choose>
                                            </table>
                                        </fieldset>
                                    </td>
                                    <td valign='top' width=50%>
                                        <fieldset>
                                            <legend><fmt:message key="time"/></legend>
                                            <table cellpadding="5" cellspacing="0">
                                            <tr>
                                                <td>&nbsp;</td>
                                                <td>
                                                    <table cellpadding="0" cellspacing="0">
                                                        <tr>
                                                            <td>
                                                                <input type=checkbox name="allDay" <c:if test="${compose.allDay eq '1'}">checked</c:if> value="1">
                                                            </td>
                                                            <td>
                                                               <fmt:message key="allDayEvent"/>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="1%" align="right"><fmt:message key="start"/>:</td>
                                                <td>
                                                    <table cellpadding="0" cellspacing="0">
                                                        <tr>
                                                            <td>
                                                                <input type=text size="12" maxlength="20" name="startDate" value="${fn:escapeXml(compose.startDate)}">
                                                            </td>
                                                            <td>&nbsp;</td>
                                                            <td>@</td>
                                                            <td>&nbsp;</td>
                                                            <td>
                                                                <select name="startHour">
                                                                    <c:set var="h" value="${compose.startHour}"/>
                                                                    <option <c:if test="${h eq 1}">selected </c:if>value="1">1
                                                                    <option <c:if test="${h eq 2}">selected </c:if> value="2">2
                                                                    <option <c:if test="${h eq 3}">selected </c:if> value="3">3
                                                                    <option <c:if test="${h eq 4}">selected </c:if> value="4">4
                                                                    <option <c:if test="${h eq 5}">selected </c:if> value="5">5
                                                                    <option <c:if test="${h eq 6}">selected </c:if> value="6">6
                                                                    <option <c:if test="${h eq 7}">selected </c:if> value="7">7
                                                                    <option <c:if test="${h eq 8}">selected </c:if> value="8">8
                                                                    <option <c:if test="${h eq 9}">selected </c:if> value="9">9
                                                                    <option <c:if test="${h eq 10}">selected </c:if> value="10">10
                                                                    <option <c:if test="${h eq 11}">selected </c:if> value="11">11
                                                                    <option <c:if test="${h eq 0}">selected </c:if> value="0">12
                                                                </select>
                                                            </td>
                                                            <td>&nbsp;</td>
                                                            <td>:</td>
                                                            <td>&nbsp;</td>
                                                            <td>
                                                                <select name="startMinute">
                                                                    <c:set var="m" value="${compose.startMinute}"/>
                                                                    <option <c:if test="${m eq 0}">selected </c:if> value="0">00
                                                                    <option <c:if test="${m eq 5}">selected </c:if> value="5">05
                                                                    <option <c:if test="${m eq 10}">selected </c:if> value="10">10
                                                                    <option <c:if test="${m eq 15}">selected </c:if> value="15">15
                                                                    <option <c:if test="${m eq 20}">selected </c:if> value="20">20
                                                                    <option <c:if test="${m eq 25}">selected </c:if> value="25">25
                                                                    <option <c:if test="${m eq 30}">selected </c:if> value="30">30
                                                                    <option <c:if test="${m eq 35}">selected </c:if> value="35">35
                                                                    <option <c:if test="${m eq 40}">selected </c:if> value="40">40
                                                                    <option <c:if test="${m eq 45}">selected </c:if> value="45">45
                                                                    <option <c:if test="${m eq 50}">selected </c:if> value="50">50
                                                                    <option <c:if test="${m eq 55}">selected </c:if> value="55">55
                                                                </select>
                                                            </td>
                                                            <td>&nbsp;</td>
                                                            <td>
                                                                <select name="startAmPm">
                                                                    <option <c:if test="${compose.startAmPm eq 'AM'}">selected </c:if>value="AM">AM</option>
                                                                    <option <c:if test="${compose.startAmPm eq 'PM'}">selected </c:if> value="PM">PM</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="1%" align="right"><fmt:message key="end"/>:</td>
                                                <td>
                                                    <table cellpadding="0" cellspacing="0">
                                                        <tr>
                                                            <td>
                                                                <input type=text size="12" maxlength="20" name="endDate" value="${fn:escapeXml(compose.endDate)}">
                                                            </td>
                                                            <td>&nbsp;</td>
                                                            <td>@</td>
                                                            <td>&nbsp;</td>
                                                            <td>
                                                                <select name="endHour">
                                                                    <c:set var="h" value="${compose.endHour}"/>
                                                                    <option <c:if test="${h eq 1}">selected </c:if>value="1">1
                                                                    <option <c:if test="${h eq 2}">selected </c:if> value="2">2
                                                                    <option <c:if test="${h eq 3}">selected </c:if> value="3">3
                                                                    <option <c:if test="${h eq 4}">selected </c:if> value="4">4
                                                                    <option <c:if test="${h eq 5}">selected </c:if> value="5">5
                                                                    <option <c:if test="${h eq 6}">selected </c:if> value="6">6
                                                                    <option <c:if test="${h eq 7}">selected </c:if> value="7">7
                                                                    <option <c:if test="${h eq 8}">selected </c:if> value="8">8
                                                                    <option <c:if test="${h eq 9}">selected </c:if> value="9">9
                                                                    <option <c:if test="${h eq 10}">selected </c:if> value="10">10
                                                                    <option <c:if test="${h eq 11}">selected </c:if> value="11">11
                                                                    <option <c:if test="${h eq 0}">selected </c:if> value="0">12
                                                                </select>
                                                            </td>
                                                            <td>&nbsp;</td>
                                                            <td>:</td>
                                                            <td>&nbsp;</td>
                                                            <td>
                                                                <select name="endMinute">
                                                                    <c:set var="m" value="${compose.endMinute}"/>
                                                                    <option <c:if test="${m eq 0}">selected </c:if> value="0">00
                                                                    <option <c:if test="${m eq 5}">selected </c:if> value="5">05
                                                                    <option <c:if test="${m eq 10}">selected </c:if> value="10">10
                                                                    <option <c:if test="${m eq 15}">selected </c:if> value="15">15
                                                                    <option <c:if test="${m eq 20}">selected </c:if> value="20">20
                                                                    <option <c:if test="${m eq 25}">selected </c:if> value="25">25
                                                                    <option <c:if test="${m eq 30}">selected </c:if> value="30">30
                                                                    <option <c:if test="${m eq 35}">selected </c:if> value="35">35
                                                                    <option <c:if test="${m eq 40}">selected </c:if> value="40">40
                                                                    <option <c:if test="${m eq 45}">selected </c:if> value="45">45
                                                                    <option <c:if test="${m eq 50}">selected </c:if> value="50">50
                                                                    <option <c:if test="${m eq 55}">selected </c:if> value="55">55
                                                                </select>
                                                            </td>
                                                            <td>&nbsp;</td>
                                                            <td>
                                                                <select name="endAmPm">
                                                                    <option <c:if test="${compose.endAmPm eq 'AM'}">selected </c:if> value="AM">AM</option>
                                                                    <option <c:if test="${compose.endAmPm eq 'AM'}">selected </c:if> value="PM" selected>PM</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <c:if test="${mailbox.prefs.useTimeZoneListInCalendar}">
                                                <tr>
                                                    <td nowrap align=right>
                                                        <fmt:message key="timeZonePref"/> :
                                                    </td>
                                                    <td>
                                                        <select name="timeZone">
                                                            <zm:forEachTimeZone var="tz">
                                                                <option
                                                                        <c:if test="${compose.timeZone eq tz.id}">selected</c:if>
                                                                        value="${fn:escapeXml(tz.id)}">${fn:escapeXml(tz.display)}</option>
                                                            </zm:forEachTimeZone>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </c:if>
                                            </table>
                                        </fieldset>
                                    </td>
                                </tr>
                            </table>
                        </td>

                        </tr>
                        <tr>
                            <td valign='top' width=1% align=right nowrap> <fmt:message key="attendees"/>: </td>
                            <td colspan=2 nowrap><textarea rows="2" style='width:99%' cols="80"
                                                               name="attendees">${fn:escapeXml(compose.attendees)}</textarea></td>
                        </tr>
                        <c:set var="firstAttachment" value="${true}"/>
                        <c:if test="${!empty compose.messageAttachments}">
                                <c:forEach var="ma" items="${compose.messageAttachments}" varStatus="status">
                                    <tr>
                                        <td align='right'>
                                            <c:if test="${firstAttachment}">
                                                <app:img altkey="ALT_ATTACHMENT" src="common/Attachment.gif"/>
                                                <c:set var="firstAttachment" value="${false}"/>
                                            </c:if>
                                        </td>
                                        <td colspan=2>
                                            <c:choose>
                                                <c:when test="${empty ma.subject}"><fmt:message var="subj" key="noSubject"/></c:when>
                                                <c:otherwise><c:set var="subj" value="${zm:truncate(ma.subject,100,true)}"/></c:otherwise>
                                            </c:choose>
                                                ${fn:escapeXml(subj)}
                                            <input type="hidden" name="messageAttachment" value="${ma.id}:${fn:escapeXml(ma.subject)}"/>
                                        </td>
                                    </tr>
                                </c:forEach>
                            </c:if>
                        <c:if test="${!empty compose.originalAttachments}">
                                <c:forEach var="part" items="${compose.originalAttachments}" varStatus="status">
                                    <tr class="CompOrigAtt" valign="middle">
                                        <td align='right'>
                                            <c:if test="${firstAttachment}">
                                                <app:img altkey="ALT_ATTACHMENT" src="common/Attachment.gif"/>
                                                <c:set var="firstAttachment" value="${false}"/>
                                            </c:if>
                                        </td>
                                        <c:set var="url" value="/service/home/~/?id=${message.id}&part=${part.partName}&auth=co"/>
                                        <c:set var="pname" value="${part.displayName}"/>
                                        <c:if test="${empty pname}">
                                            <fmt:message key="unknownContentType" var="pname">
                                                <fmt:param value="${part.contentType}"/>
                                            </fmt:message>
                                        </c:if>
                                        <td>
                                            <table cellpadding=0 cellspacing=0 border="0">
                                                <tr valign="middle">
                                                    <td>
                                                        <input <c:if test="${compose.checkedAttachmentNames[part.partName]}">checked </c:if>type=checkbox name="originalAttachment" value="${part.partName}">
                                                    </td>
                                                    <td>&nbsp;</td>
                                                    <td>
                                                        <a target="_blank" href="${url}&disp=i">${fn:escapeXml(pname)}</a>&nbsp;(${part.displaySize})
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </c:forEach>
                        </c:if>
                        <tr>
                            <td colspan="3" style='padding:10px'>
                                <textarea class='MsgCompose' rows="30" cols="80" style='width:100%'
                                              name="body">${fn:escapeXml(compose.content)}</textarea>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td class='TbBottom'>
                    &nbsp;
                </td>
            </tr>
        </table>
        <input type="hidden" name="replyto" value="${fn:escapeXml(compose.replyTo)}"/>
        <input type="hidden" name="from" value="${fn:escapeXml(compose.from)}"/>
        <input type="hidden" name="inreplyto" value="${fn:escapeXml(compose.inReplyTo)}"/>
        <input type="hidden" name="messageid" value="${fn:escapeXml(compose.messageId)}"/>
        <input type="hidden" name="replytype" value="${fn:escapeXml(compose.replyType)}"/>
        <c:if test="${message.isDraft}">
            <input type="hidden" name="draftid" value="${message.id}"/>
        </c:if>
    </form>
</app:view>
