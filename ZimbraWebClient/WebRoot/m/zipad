<%@ page import="com.zimbra.common.mime.MimeCompoundHeader" %>
<%@ page import="com.zimbra.cs.httpclient.URLUtil" %>
<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="mo" uri="com.zimbra.mobileclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="com.zimbra.i18n" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<c:set var="F_LIMIT" value="${not empty sessionScope.F_LIMIT ? sessionScope.F_LIMIT : 100}" scope="session"/>
<c:if test="${empty param.ajax}"><?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<c:if test="${(!empty param.debug || !empty param.dev)}"><c:set var="dbg" value="${true}"/></c:if>
<c:remove var="prevUrl" scope="session"/><c:remove var="currentUrl" scope="session"/></c:if>
<c:url var="baseURL" scope="request" value="${requestScope.baseURL!=null?requestScope.baseURL:'zipad'}"/>
<c:set var="context_url" value="${requestScope.baseURL}"/>
<c:if test="${param.loginOp=='logout'}"><c:remove var="mapp" scope="session"/><c:redirect url="/"><c:param name="loginOp" value="logout"/><c:param name="client" value="mobile"/></c:redirect></c:if>
<%--<c:if test="${not empty param.ajax}">--%>
    <c:url var="prevUrl" scope="session" value="${sessionScope.currentUrl}"/>
    <c:url var="currentUrl" scope="session" value="zipad">
        <c:forEach items="${param}" var="p"><c:param name="${p.key}" value="${p.value}"/></c:forEach>
    </c:url>
<%--</c:if>--%>
<c:if test="${not empty param.djs}"><c:set var="djs" value="${fn:escapeXml(param.djs)}" scope="session" /></c:if>
<c:set var="version" value="${initParam.zimbraCacheBusterVersion}"/>
<c:set var="uiv" value="1" scope="session"/>
<mo:handleError>
    <zm:getMailbox var="mailbox"/>
    <zm:getUserAgent var="ua" session="true"/>
    <c:choose>
        <c:when test="${not empty mailbox.prefs.locale}">
            <fmt:setLocale value='${mailbox.prefs.locale}' scope='request'/>
        </c:when>
        <c:otherwise>
            <fmt:setLocale value='${pageContext.request.locale}' scope='request'/>
        </c:otherwise>
    </c:choose>
    <fmt:setBundle basename="/messages/ZhMsg" scope="request"/>
    <mo:apptComposeCheck/>
    <mo:composeCheck/>
    <c:choose>
        <c:when test="${not empty param.doPrefsAction}">
            <zm:modifyPrefs var="updated">
                <zm:pref name="zimbraPrefTimeZoneId" value="${param.zimbraPrefTimeZoneId}"/>
                <c:if test="${mailbox.features.conversations}">
                    <zm:pref name="zimbraPrefGroupMailBy" value="${param.zimbraPrefGroupMailBy}"/>
                </c:if>
                <c:if test="${mailbox.features.initialSearchPreference}">
                    <zm:pref name="zimbraPrefMailInitialSearch" value="${param.zimbraPrefMailInitialSearch}"/>
                </c:if>
                <zm:pref name="zimbraPrefAutoAddAddressEnabled" value="${param.zimbraPrefAutoAddAddressEnabled eq 'TRUE' ? 'TRUE' : 'FALSE'}"/>
                <zm:pref name="zimbraPrefContactsPerPage" value="${param.zimbraPrefContactsPerPage}"/>
                <zm:pref name="zimbraPrefMailItemsPerPage" value="${param.zimbraPrefMailItemsPerPage}"/>
                <zm:pref name="zimbraPrefCalendarFirstdayOfWeek" value="${param.zimbraPrefCalendarFirstdayOfWeek}"/>
                <zm:pref name="zimbraPrefUseTimeZoneListInCalendar" value="${param.zimbraPrefUseTimeZoneListInCalendar eq 'TRUE' ? 'TRUE' : 'FALSE'}"/>
            </zm:modifyPrefs>
            <c:set var="flimit" value="${zm:cook(param.F_LIMIT)}"/>
            <c:choose>
                <c:when test="${flimit gt 0 and flimit le 1000}">
                    <c:set var="F_LIMIT" scope="session" value="${flimit}"/>
                </c:when>
                <c:otherwise>
                    <c:redirect url="zmview?st=prefs&emsg=MO_MaxFoldersInvalidValueMsg"/>
                </c:otherwise>
            </c:choose>
            <c:if test="${updated}">
                <zm:getMailbox var="mailbox" refreshaccount="${true}"/>
                <c:set var="limit" value="${mailbox.prefs.mailItemsPerPage}" scope="session"/>
                <zm:clearSearchCache />
                <app:status><fmt:message key="optionsSaved"/></app:status>
            </c:if>
        </c:when>
        <c:when test="${not empty param.doMessageAction}">
            <mo:messageAction/>
        </c:when>
        <c:when test="${not empty param.doBriefcaseAction}">
            <mo:briefcaseAction/>
        </c:when>
        <c:when test="${not empty param.doTaskAction}">
            <mo:taskAction/>
        </c:when>
        <c:when test="${not empty param.doContactAction}">
            <mo:contactAction/>
        </c:when>
        <c:when test="${not empty param.doFolderAction}">
            <mo:folderAction/>
        </c:when>
    </c:choose>
    <c:set var="action" value="${zm:cook(empty param.paction ? param.action : param.paction)}" scope="request"/>
</mo:handleError>
<c:if test="${empty sessionScope.zms}">
    <c:set value="${ua.isiPhone || ua.isiPod ? 'iphone' : (ua.isiPad ? 'ipad' : ( ua.isIE ? 'wm6' : 'ipad'))}" var="zms" scope="session"/>
</c:if>
<%-- just to make sure we are using ipad TODO: to set it differently--%>
<c:set var="zms" value="${'ipad'}" scope="session"/>
<c:if test="${not empty param.zms}">
    <c:set value="${fn:escapeXml(param.zms)}" var="zms" scope="session"/>
</c:if>
<c:if test="${sessionScope.limit == null}">
    <c:set var="limit" value="${sessionScope.zms eq 'xlite' ? '5' : mailbox.prefs.mailItemsPerPage}" scope="session"/>
</c:if>
<c:if test="${(sessionScope.limit != param.limit && param.limit != null && param.limit != '')  }">
    <c:set var="limit" value="${zm:cook(param.limit)}" scope="session"/>
</c:if>
<c:set var="aurl" value="${context_url}"/>
<%-- Access keys --%>
<c:set var="mailapp_accesskey" value="1" scope="request"/>
<c:set var="contactapp_accesskey" value="2" scope="request"/>
<c:set var="calapp_accesskey" value="3" scope="request"/>
<c:set var="fldrapp_accesskey" value="4" scope="request"/>
<c:set var="search_accesskey" value="5" scope="request"/>
<c:set var="navlink_accesskey" value="6" scope="request"/>
<c:set var="prev_accesskey" value="7" scope="request"/>
<c:set var="next_accesskey" value="8" scope="request"/>
<c:set var="mainaction_accesskey" value="0" scope="request"/>
<c:if test="${empty param.ajax}"><head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<title><fmt:message key="zimbraTitle"/></title>
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;"/>
<script type="text/javascript">window.onerror=function(m,u,l){if(window.console){window.console.log("An error occured in: "+u+"\n{\n\tmsg: "+m+",\n\tline: "+l+"\n}");}return false;};</script>
<c:if test="${empty djs or not djs}"><script type="text/javascript">window.currentUrl='<c:url value="${currentUrl}"><c:param name="ajax" value="true"/></c:url>';<c:import url="/m/mojs${dbg ? '?dev=1':''}"/></script></c:if>
<link href="<c:url value='/css/ipad.css'/>" type="text/css" rel="stylesheet"/>
</head>

<body>
	<div class="topbar">

		<a href="www.zimbra.com" target="_new"><div class="logo"></div></a>

		
				<ul class="ul alignLeft">
					<li class="sel"><a id="mail" href="${aurl}?st=${mailbox.prefs.groupMailBy}"><span onclick="return zClickLink('mail')"><fmt:message key="mail"/></span></a></li>
					<li><a id="contact" href="${aurl}?st=contact"><span onclick="return zClickLink('contact')"><fmt:message key="contacts"/></span></a></li>
					<li><a id="cal" href=""><span><fmt:message key="calendar"/></span></a></li>
					<li><a id="tasks" href=""><span><fmt:message key="tasks"/></span></a></li>
					<li><a id="options" href=""><span><fmt:message key="options"/></span></a></li>
				</ul>
		

		<div class="signout alignRight"><a href="#">Sign out</a></div>

		<div class="search alignRight"><input type="search" placeholder="Search..."></div>


	</div>
</c:if>
<c:if test="${empty param.ajax}">

</c:if>
	<mo:handleError>
        <c:import url="/m/zmview" var="response" scope="page"/>
    </mo:handleError>
    <%  //!TODO may be should be done through filter? but minimization of html is essential to reduce response size
        String respText = (String)pageContext.getAttribute("response");
        respText = respText.replaceAll("[\t ]+"," ").replaceAll("\n\\s*\n","\n");
        pageContext.setAttribute("response",respText);
    %>

<c:if test="${param.ajax}">
    ${response}                
</c:if>

<c:if test="${empty param.ajax}">
    <div class="view">

        <div class="listViewPane" id="view-list">
			
	<!-- List view Toolbar -->		
			
			<div class="overviewActions toolbar">

				<div class="folder button"><div>Folders</div></div>

				<div class="icons button"></div>
				<div class="icons button"></div>
				<div class="select button">
					<div>
						<select>
							<option>Move to...</option>
							<option>Inbox</option>
							<option>Sent</option>
							<option>Spam</option>
							<option>Trash</option>
							<option>----------------</option>
							<option>Personal Folder 1</option>
							<option>Personal Folder 2</option>
						</select>
					</div>
				</div>
				
				</div>
				
            ${response}

        </div>

        <div class="contentViewPane" id="view-content">

 <!--Application Toolbar  -->
    
        <div class="applicationActions toolbar">

			<div class="compose button"><div>Compose</div></div>

			<div class="actions">
				<div class="left button"><div>Reply</div></div>
				<div class="center button"><div>Reply all</div></div>
				<div class="right button"><div>Forward</div></div>
			</div>
		</div>

            <div class="header">
                <div class="alignLeft subject">Main Build Failing</div>
                <div class="alignLeft time">Thur, Apr 08, 2010 &nbsp; 9:44pm</div>
            </div>

            <div class="msgBody">
                <div class="address">From: &nbsp; Greg Solovyev</div>
                <div class="address">To: &nbsp; ui-team</div> <br>

                <p>
                    Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum<br>

                    Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
                </p><br>

            </div>
	    </div>

    </div>
</c:if>

<c:if test="${empty param.ajax}">
</body>

</html></c:if>