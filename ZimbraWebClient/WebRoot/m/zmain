<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="mo" uri="com.zimbra.mobileclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="com.zimbra.i18n" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<c:set var="baseURL" scope="request" value="${requestScope.baseURL!=null?requestScope.baseURL:'zmain'}"/>
<c:set var="context_url" value="${requestScope.baseURL}"/>
<c:if test="${param.loginOp=='logout'}">
    <c:redirect url="/?loginOp=logout&client=mobile"/>
</c:if>
<c:if test="${not empty param.ajax}">
    <c:set var="prevUrl" scope="session" value="${sessionScope.currentUrl}"/>
    <c:set var="currentUrl" scope="session"
           value="${pageContext.request.requestURL}?${pageContext.request.queryString}"/>
</c:if>
<c:if test="${empty param.ajax}">
    <c:remove var="prevUrl" scope="session"/>
    <c:remove var="currentUrl" scope="session"/>
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
</c:if>
<c:set var="version" value="${initParam.zimbraCacheBusterVersion}"/>
<c:set var="uiv" value="1" scope="session"/>
<mo:handleError>
    <zm:getMailbox var="mailbox"/>
    <zm:getUserAgent var="ua" session="false"/>
    <c:choose>
        <c:when test="${not empty mailbox.prefs.locale}">
            <fmt:setLocale value='${mailbox.prefs.locale}' scope='request'/>
        </c:when>
        <c:otherwise>
            <fmt:setLocale value='${pageContext.request.locale}' scope='request'/>
        </c:otherwise>
    </c:choose>
    <fmt:setBundle basename="/messages/ZhMsg" scope="request"/>
    <mo:apptComposeCheck/>
    <mo:composeCheck/>
    <c:choose>
        <c:when test="${not empty param.doMessageAction}">
            <mo:messageAction/>
        </c:when>
        <c:when test="${not empty param.doBriefcaseAction}">
            <mo:briefcaseAction/>
        </c:when>
        <c:when test="${not empty param.doTaskAction}">
            <mo:taskAction/>
        </c:when>
        <c:when test="${not empty param.doContactAction}">
            <mo:contactAction/>
        </c:when>
        <c:when test="${not empty param.doFolderAction}">
            <mo:folderAction/>
        </c:when>
    </c:choose>
    <c:set var="action" value="${zm:cook(empty param.paction ? param.action : param.paction)}" scope="request"/>
</mo:handleError>
<c:if test="${empty sessionScope.zms}">
    <c:set value="${ua.isiPhone || ua.isiPod ? 'iphone-ext' : ( ua.isIE ? 'wm6' : 'iphone-ext')}" var="zms"
           scope="session"/>
</c:if>
<c:if test="${not empty param.zms}">
    <c:set value="${fn:escapeXml(param.zms)}" var="zms" scope="session"/>
</c:if>
<!-- SKIN param:'${param.zms}' '${sessionScope.zms}' -->
<c:if test="${sessionScope.limit == null}">
    <c:set var="limit" value="${sessionScope.zms eq 'xlite' ? '5' : '10'}" scope="session"/>
</c:if>
<c:if test="${(sessionScope.limit != param.limit && param.limit != null && param.limit != '')  }">
    <c:set var="limit" value="${zm:cook(param.limit)}" scope="session"/>
</c:if>
<c:set var="aurl" value="${context_url}"/>
<%-- Access keys --%>
<c:set var="mailapp_accesskey" value="1" scope="request"/>
<c:set var="contactapp_accesskey" value="2" scope="request"/>
<c:set var="calapp_accesskey" value="3" scope="request"/>
<c:set var="fldrapp_accesskey" value="4" scope="request"/>
<c:set var="search_accesskey" value="5" scope="request"/>
<c:set var="navlink_accesskey" value="6" scope="request"/>
<c:set var="prev_accesskey" value="7" scope="request"/>
<c:set var="next_accesskey" value="8" scope="request"/>
<c:set var="mainaction_accesskey" value="0" scope="request"/>
<c:if test="${empty param.ajax}">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>
    <fmt:message key="zimbraTitle"/>
</title>
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;"/>
<c:set var="calcss" value=",${sessionScope.zms}-cal"/>
<link href="<c:url value='/css/${sessionScope.zms}${calcss}.css?v=${version}'/>" type="text/css" rel="stylesheet"/>
<style type="text/css">
.hidden {
    opacity: 0.0;
    height: 0px;
    visibility: hidden;
}
.shown {
    opacity: 0.9;
    height: 0px;
    visibility:visible;
}
</style>
<mo:js ua="${ua}" mailbox="${mailbox}"/>
</head>
<body onorientationchange="updateOrientation()">
<div class="container table" id="appbar" align="center">
    <div class="table-row">
            <%-- <div class="table-cell">--%> <c:set var="appcount" value="1"/> <c:if
            test="${mailbox.features.mail}"> <c:set var="appcount" value="${appcount+1}"/> </c:if> <c:if
            test="${mailbox.features.contacts}"> <c:set var="appcount" value="${appcount+1}"/> </c:if>
            <c:if test="${mailbox.features.calendar}"> <c:set var="appcount" value="${appcount+1}"/></c:if>
            <c:if test="${mailbox.features.briefcases || mailbox.features.notebook}"> <c:set var="appcount" value="${appcount+1}"/></c:if>
            <%--c:if test="${mailbox.features.tasks}"> <c:set var="appcount" value="${appcount+1}"/></c:if--%>
            <c:set
            var="active"
            value="${empty param.st || param.st eq 'message' || param.st eq 'conversation' || param.st eq 'folders' ? '-active' : ''}"/> <a
            style='width: ${95/appcount}%;' targetid="maincontainer" accesskey="${requestScope.mailapp_accesskey}"
            id="mail" class="mail${active} appTab${active} table-cell" href="${aurl}?st=${mailbox.prefs.groupMailBy}"><span
            onclick="return zClickLink('mail')"><fmt:message
            key="mail"/></span><span onclick="return zClickLink('mail')" style="display:none;"
                                     class="apunread">${mailbox.inbox.unreadCount}</span> </a> <c:if
            test="${mailbox.features.contacts}"> <c:set var="active"
                                                        value="${param.st eq 'contact' || param.st eq 'ab' ? '-active' : ''}"/>
        <a style='width: ${95/appcount}%;' targetid="maincontainer" accesskey="${requestScope.contactapp_accesskey}"
           id="contact" class="contact${active} appTab${active} table-cell" href="${aurl}?st=contact"><span
                onclick="return zClickLink('contact')"><fmt:message key="contacts"/></span></a>
            </c:if>
        <c:if test="${mailbox.features.calendar}">
        <c:set var="active" value="${param.st eq 'cal' || param.st eq 'cals' ? '-active' : ''}"/>
        <a style='width: ${95/appcount}%;' targetid="maincontainer" accesskey="${requestScope.calapp_accesskey}"
           id="cal" class="cal${active} appTab${active} table-cell" href="${aurl}?st=cal"><span
                onclick="return zClickLink('cal')"><fmt:message
                key="calendar"/></span>
            <span onclick="return zClickLink('cal')" style="display:none;" class="aptoday">
            <fmt:formatDate value="${zm:getToday(mailbox.prefs.timeZone).time}" timeZone="${mailbox.prefs.timeZone}"
                            pattern="EEE|d|MMM" var="today"/>
            <c:set var="darr" value="${fn:split(today,'|')}"/>
            <div class="_day">${darr[0]}</div>
            <div class="_date">${darr[1]}</div>
            <div class="_month">${darr[2]}</div>
            </span></a>
         </c:if>
         <%--c:if test="${mailbox.features.tasks}">
            <c:set var="active" value="${param.st eq 'tasks' || param.st eq 'task' ? '-active' : ''}"/>
            <a style='width: ${100/appcount}%;' targetid="maincontainer" accesskey="${requestScope.taskapp_accesskey}"
               id="tasks" class="appTab${active} table-cell" href="${aurl}?st=task"><span
                    onclick="return zClickLink('cal')"><fmt:message
                    key="tasks"/></span>
            </a>
         </c:if--%>                             
         <c:if test="${mailbox.features.briefcases || mailbox.features.notebook}">
            <c:if test="${not empty param.l_view}">
                <c:set var="l_view" value="${fn:escapeXml(param.l_view)}" scope="session"/>
            </c:if>
            <c:if test="${empty sessionScope.l_view}">
            <c:set var="l_view" value="list" scope="session"/>
            </c:if>
        <c:set var="active" value="${param.st eq 'tasks' || param.st eq 'task'|| param.st eq 'briefcase' || param.st eq 'wiki' || param.st eq 'briefcases' || param.st eq 'notebooks' ? '-active' : ''}"/>
        <a style='width: ${98/appcount}%;' targetid="maincontainer" accesskey="${requestScope.fldrapp_accesskey}"
           id="docs" class="folders${active} appTab${active} table-cell" href="${aurl}?st=${mailbox.features.briefcases ? 'briefcases' : 'notebooks'}"><span
                onclick="return zClickLink('docs')"><fmt:message
                key="folders"/></span></a>
        </c:if>
        <c:set var="active" value="${param.search eq '1' ? '' : ''}"/>
        <a style='width: ${95/appcount}%;' targetid="maincontainer" accesskey="${requestScope.search_accesskey}"
           id="search" class="search${active} appTab${active} table-cell"
           href="${aurl}?search=${param.search eq '1' ? '0' : '1'}&amp;${fn:replace(pageContext.request.queryString,'search=1&amp;','')}"
           onclick='return toggleElem("searchbar",this);'><span><fmt:message key="search"/></span></a>
    </div>
</div>
<div class="container" id="msgDiv"></div>
<div style="display:none;position:absolute;" class="container loadingIcon" id="curDiv"></div>
</c:if>
<div class="container" id="maincontainer">
    <script type="text/javascript">
        if(document.location.hash && document.location.hash != currHash && getXHR()){
            getContainer().style.visibility = 'hidden';
        }
    </script>
    <div class="container table" id="searchbar" style="${param.search eq '1' ? '' : 'display:none;'}">
        <div class="table-row">
            <form method="post" action="${context_url}" class="table-cell"
                  onsubmit="if(!this.sq.value){showLoadingMsg('<fmt:message key="actionNoSearchQuerySpecified"/>',true,'Warning',1000);return false;}else{return submitForm(this);}">
                <c:if test="${not empty param.invId}"> <input type="hidden" name="invId"
                                                              value="${zm:cook(param.invId)}"/> </c:if> <input
                    type="hidden"
                    name="search"
                    value="1"/>
                <c:if test="${not empty param.st}">
                    <c:choose>
                        <c:when test="${param.st eq 'folders'}">
                            <input type="hidden" name="st" value="${mailbox.prefs.groupMailBy}"/>
                        </c:when>
                         <c:when test="${param.st eq 'ab'}">
                            <input type="hidden" name="st" value="contact"/>
                        </c:when>
                         <c:when test="${param.st eq 'cals'}">
                            <input type="hidden" name="st" value="cal"/>
                        </c:when>
                        <c:when test="${param.st eq 'briefcases'}">
                            <input type="hidden" name="st" value="briefcase"/>
                        </c:when>
                        <c:when test="${param.st eq 'notebooks'}">
                            <input type="hidden" name="st" value="wiki"/>
                        </c:when>
                        <c:otherwise>
                            <input type="hidden" name="st" value="${fn:escapeXml(param.st)}"/>
                        </c:otherwise>
                    </c:choose>
                </c:if>
                <input
                    type="hidden" name="crumb"
                    value="${fn:escapeXml(mailbox.accountInfo.crumb)}"/> <%-- <span class="table-cell" width="70%">--%>
                <input type="text" class="searchInput" name="sq" value="${zm:cook(param.sq)}"/><input type="submit" class="searchButton zo_button" name="actionSearch"
                       value="<fmt:message key="search"/>"/><!--</span>-->
            </form>
        </div>
    </div>
    <div class="container table" id="savesearchbar" style="${param.saveSearch eq '1' ? '' : 'display:none;'}">
        <div class="table-row">
            <form method="post" action="${context_url}" class="table-cell"
                  onsubmit="if(!this.sname.value){showLoadingMsg('<fmt:message key="actionNoNameSpecified"/>',true,'Warning',1000,'msgbar');return false;}else{return submitForm(this);}">
                <input type="hidden" name="query" value="${zm:cook(param.sq)}"/>
                <input type="hidden" name="st" value="${empty param.st? mailbox.prefs.groupMailBy : (param.st eq 'cal' ? 'appointment' : zm:cook(param.st))}"/>
                <input type="hidden" name="doFolderAction" value="1"/>
                <input type="hidden" name="parentid" value="${mailbox.inbox.parentId}"/>
                <input
                        type="hidden" name="crumb"
                        value="${fn:escapeXml(mailbox.accountInfo.crumb)}"/> <%-- <span class="table-cell" width="70%">--%>
                <span class="label"><fmt:message key="searchNameLabel"/></span>
                <input type="text" class="searchInput" style="width:30%;" name="sname" value="${zm:cook(param.sname)}"/>
                <!--</span>
              <span class="table-cell" width="30%">-->
                <input type="submit" class="searchButton zo_button" name="actionSaveSearch"
                       value="<fmt:message key="save"/>"/><!--</span>-->
            </form>
        </div>
    </div>
    <mo:handleError>
        <div class="container" id="msgbar" style="">
            <c:choose> <c:when test="${not empty param.appmsg}">
                <c:set var="statusMessage" value="${fn:escapeXml(param.appmsg)}"/>
                <c:set var="statusClass" value="Info"/>
                <div class='StatusInfo' id='statusdiv'><fmt:message key="${fn:escapeXml(param.appmsg)}"/></div>
            </c:when> <c:when test="${not empty requestScope.statusMessage}">
                <c:set var="statusMessage" value="${fn:escapeXml(requestScope.statusMessage)}"/>
                <c:set var="statusClass" value="${requestScope.statusClass}"/>
                <div class="${requestScope.statusClass}"
                     id='statusdiv'>${fn:escapeXml(requestScope.statusMessage)}</div>
            </c:when> </c:choose>
            <script type="text/javascript">
                top.showLoadingMsg(null, false);//hide loading div
                top.showLoadingMsg('${statusMessage}', true,'${statusClass}',4000,'msgbar',true);
            </script>
            <c:remove var="statusMessage"/> <%-- cleanup when rendered--%>
        </div>
        <div class="container" id="body">
            <c:import url="/m/zmview"/>
        </div>
    </mo:handleError>
</div>
<script type="text/javascript"> //This code runs from the ajax response
    var d = document.getElementById('statusdiv');
    var nojs = false;
    var msg = (d) ? d.innerHTML : null;
    if (self.parent && msg) {
        if(d.className && d.className.indexOf("StatusInfo") > -1){
            self.parent.getContainer().innerHTML = self.getContainer().innerHTML;
            nojs = true;
        }else{
            nojs = true;
        }
        self.parent.showLoadingMsg(null, false , null, 4000);
        self.parent.showLoadingMsg(null, false, null,4000,'msgbar',true);
    }
    <c:if test="${not empty requestScope.title}">
    document.title = "<fmt:message key="zimbraTitleLabel"/>"+" "+"${fn:escapeXml(requestScope.title)}";
    </c:if>
    <c:if test="${not empty requestScope.curId}">
    window.currentDate = '${requestScope.curId}';
    </c:if>
    <c:if test="${not empty requestScope._today}">
    window._today = '${requestScope._today}';
    </c:if>
</script>
<c:if test="${empty param.ajax}">
    <div class="table">
        <div class="table-row">
            <div class="container table-cell" id="userinfo">
                <c:url var="logoutUrl" value="${context_url}?loginOp=logout&client=mobile"/>
            <span class="logout-span">
            <a href="${fn:escapeXml(logoutUrl)}" id="_logout" noajax='true'> <fmt:message key="logOut"/> </a>
            (${mailbox.accountInfo.attrs["uid"][0]})</span>
            <span class="quota-span">
            <fmt:message key="MO_quotaLabel"/>
            <c:set var="max" value="${mailbox.attrs.zimbraMailQuota[0]}"/>
            <fmt:message var="unlimited" key="unlimited"/>
            <fmt:message key="MO_quotaUsage"> <fmt:param value="${zm:displaySizeFractions(pageContext, mailbox.size,2)}"/> <fmt:param
                    value="${max==0 ? unlimited : zm:displaySizeFractions(pageContext, max,2)}"/> </fmt:message>
            </span>
            </div>
        </div>
    </div>
    <div class="table container">
        <div class="table-row">
            <div class="table-cell small-gray-text list-row">
                <c:set var="v" value="${ua.isiPhone || ua.isiPod ? 'iphone-ext' : ( ua.isIE ? 'wm6' : 'xlite')}"/>
                <fmt:message key="lowBandwidth" var="lbw"/> <fmt:message key="default" var="def"/> <c:if
                    test="${fn:endsWith(sessionScope.zms,'-lowbw')}"> <c:set var="def"
                                                                             value="<a noajax='true' href='?zms=${v}&amp;limit=10'>${def}</a>"/>
            </c:if> <c:if test="${!fn:endsWith(sessionScope.zms,'-lowbw')}"> <c:set var="lbw"
                                                                                    value="<a noajax='true' href='?zms=${fn:split(sessionScope.zms,'-')[0]}-lowbw&amp;limit=5'>${lbw}</a>"/>
            </c:if> <fmt:message key="viewLabel"/> ${def} | ${lbw} | <a href="?st=versions"><fmt:message key="more"/>...</a>
            </div>
        </div>
    </div>
    <div class="table">
        <div class="table-row">
            <div class="container table-cell" id="copyright_notice">
                <a noajax='true' target="_blank" href="<fmt:message key="logoURL"/>"><fmt:message
                        key="footerCopyright"/></a>
            </div>
        </div>
    </div>
    <script type="text/javascript" xml:space="preserve">
                
        if (getXHR()) {
            <c:if test="${empty param.noframe}">
            if(!nojs){
                registerOnclickHook();
                setTimeout(function() { //!FIXME using SetInterval or polling will have performance issue
                    checkHash(document.location.href,'get',true);
                }, 350);

                <c:if test="${param.st ne 'newmail' && param.st ne 'compose' && mailbox.features.mail && (empty param.st || param.st eq mailbox.prefs.groupMailBy)}">
                // preloaded the compose
                if(document.location.hash.indexOf('newmail') < 0 && document.location.hash.indexOf('compose') < 0 ){
                    setTimeout(function() {
                        ajxReq('<c:url value="/m/zmain?st=newmail"/>',null,null,'get',true);
                    },300);
                }
                </c:if>
           }
           </c:if>    
        }
        //-->
    </script>
    </body> </html> </c:if>

