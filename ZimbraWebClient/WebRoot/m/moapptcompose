<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="mo" uri="com.zimbra.mobileclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="com.zimbra.i18n" %>
<%@ taglib prefix="app" uri="com.zimbra.htmlclient" %>
<c:set var="context_url" value="${requestScope.baseURL!=null?requestScope.baseURL:'mainx'}"/>
<c:set var="caction" value="${prevUrl}"/>
<c:choose>
<c:when test="${not empty prevUrl}">
    <c:set var="bt" value="${fn:replace(fn:substringAfter(prevUrl,'?'),'&','|')}"/>
    <c:url var="caction" value='${prevUrl}'/>
</c:when>
<c:when test="${not empty param.bt}">
    <c:set var="bt" value="${param.bt}"/>
    <c:url var="caction" value='${context_url}?${fn:replace(param.bt,"|","&")}'/>
</c:when>
<c:when test="${empty prevUrl  && empty param.bt && not empty header['referer']}">
    <c:set var="caction" value='${header["referer"]}'/>
    <c:set var="bt"
           value="${fn:replace(fn:replace(fn:substringAfter(header['referer'],'?'),'appmsg=messageSent',''),'&','|')}"/>
</c:when>
</c:choose>
<mo:handleError>
    <c:set var="context_url" value="${requestScope.baseURL!=null?requestScope.baseURL:'zmain'}"/>
    <zm:getMailbox var="mailbox"/>
    <c:choose>
        <c:when test="${not empty mailbox.prefs.locale}">
            <fmt:setLocale value='${mailbox.prefs.locale}' scope='request'/>
        </c:when>
        <c:otherwise>
            <fmt:setLocale value='${pageContext.request.locale}' scope='request'/>
        </c:otherwise>
    </c:choose>
    <fmt:setBundle basename="/messages/ZhMsg" scope="request"/>

    <%--<fmt:message var="title" key="newAppointment"/>--%>
    <fmt:message var="hourFmt" key="CAL_APPT_EDIT_HOUR_FORMAT"/>
    <zm:clearApptSummaryCache/>
    <zm:composeUploader var="uploader"/>
    <c:set var="compose" value="${uploader.compose}"/>
    <c:choose>
        <c:when test="${param.useInstance eq '1' and not empty param.exInvId}">
            <c:set var="id" value="${param.exInvId}"/>
            <c:set var="compNum" value="${empty param.exCompNum ? 0 : param.exCompNum}"/>
            <zm:getMessage var="message" id="${id}" markread="true" neuterimages="${empty param.xim}" wanthtml="false"/>
        </c:when>
        <c:when test="${not empty param.invId}">
            <c:set var="id" value="${param.invId}"/>
            <c:set var="compNum" value="${empty param.invCompNum ? 0 : param.invCompNum}"/>
            <zm:getMessage var="message" id="${id}" markread="true" neuterimages="${empty param.xim}" wanthtml="false"/>
        </c:when>
        <c:otherwise>
            <c:set var="message" value="${null}"/>
        </c:otherwise>
    </c:choose>

    <c:set var="appt" value="${empty message ? null : message.invite.component}"/>
    <c:set var="canEditRecurrence" value="${(empty appt or not appt.exception) and not compose.useInstance}"/>
    <c:set var="canDelete" value="${not empty appt}"/>
    <c:set var="hasAttendees" value="${not empty appt and not empty appt.attendees}"/>

    <c:choose>
        <c:when test="${empty compose}">
            <zm:messageCompose var="compose" message="${message}" action="${empty message ? 'apptnew' : 'apptedit'}"
                               date="${requestScope.dateContext}"
                               inviteId="${empty param.invId? null : param.invId}"
                               exceptionInviteId="${empty param.exInvId? null : param.exInvId}"
                               useInstance="${param.useInstance eq '1'}"
                               instanceStartTime="${param.instStartTime}"
                               instanceDuration="${param.instDuration}"/>
        </c:when>
        <c:when test="${uploader.isUpload and not empty message}">
            <zm:fixupMessageCompose message="${message}" compose="${compose}"
                                    newattachments="${uploader.compose.hasFileItems}"/>
        </c:when>
    </c:choose>

    <c:choose>
        <c:when test="${empty compose.inviteId}">
            <c:set var="apptImage" value="calendar/ImgNewAppointment.gif"/>
            <c:set var="apptImageAlt" value="ALT_NEW_APPOINTMENT"/>
            <fmt:message var="apptSubject" key="newAppointment"/>
            <c:set var="isNewAppt" value="${true}"/>
        </c:when>
        <c:otherwise>
            <c:set var="apptImage" value="startup/ImgAppointment.gif"/>
            <c:set var="apptImageAlt" value="ALT_EDIT_APPOINTMENT"/>
            <c:set var="apptSubject" value="${compose.subject}"/>
            <c:set var="closeImage" value="common/ImgClose.gif"/>
            <c:set var="isNewAppt" value="${false}"/>
        </c:otherwise>
    </c:choose>

    <c:set var="isInstance"
           value="${not empty appt and (appt.exception or not empty appt.recurrence) and compose.useInstance}"/>

</mo:handleError>
<fmt:message var="title" key="ALT_MSG_STATUS_APPT"/>
<fmt:message var="addedit" key="${empty message ? 'add' : 'edit'}"/>
<c:set var="title" value="${title} : ${addedit}" scope="request"/>
<c:if test="${empty param.noframe}"><iframe src='about:blank' style='display:none' name='aniframe' id='aniframe'></iframe></c:if>
<form action="?st=newappt&more=true&bt=${bt}" method="post" enctype="multipart/form-data" accept-charset="utf-8" onsubmit="return submitForm(this,'aniframe');">
<input type="hidden" name="crumb" value="${fn:escapeXml(mailbox.accountInfo.crumb)}"/>

<div class="table Toolbar">
    <div class="table-row">
        <div class="table-cell">
                    <span class="zo_tb_submit">
                        <a href="${caction}" class="zo_button"><fmt:message key="cancel"/></a>
                    </span>
                    <span class='zo_tb_submit'>
                        <input class="zo_button" name="actionSave" type="submit" value="<fmt:message key="save"/>">
                    </span>

        </div>
    </div>
</div>

<div class="Stripes cmp_appt_container">
<div class="View"><b>${fn:escapeXml(apptSubject)}</b></div>
<c:if test="${isInstance}">
    <div class="View">
        <div class="table">
            <div class="table-row">
                <span class="table-cell ZhApptRecurrInfo"><app:img
                        src="dwt/ImgInformation.gif"/></span>
                <span class="table-cell">
                    <c:url value="${context_url}?st=newappt&bt=${bt}&useInstance=0&invId=${id}" var="apptUrl"/>
                    <fmt:message key="apptInstNote"/>
                    <hr size="1">
                    <a href="${apptUrl}"><fmt:message key="apptInstEditSeries"/></a>
                </span>
            </div>
        </div>
    </div>
</c:if>
<div class="View">
    <div class="table">
        <div class="table-row cmp_to_row">
            <span class="label table-cell"><fmt:message key="subject"/>:</span>
            <span class="table-cell"><input type="text" class="Textarea" value="${fn:escapeXml(compose.subject)}"
                                            name="subject"></span>
        </div>
        <div class="table-row cmp_to_row">
            <span class="label table-cell"><fmt:message key="location"/>:</span>
            <span class="table-cell"><input class="Textarea" type="text" value="${fn:escapeXml(compose.location)}"
                                            name="location"></span>
        </div>
    </div>
</div>

<div class="View">
<div class="table">
    <div class="table-row cmp_to_row">
        <span class="label table-cell"><fmt:message key="start"/>:</span>
    <span class="table-cell"><input class="Textarea" id="start" type=text size="12" maxlength="20" name="startDate"
                                    value="${fn:escapeXml(compose.startDate)}"> @ <select name="startHour">
        <c:set var="h" value="${compose.startHour}"/>
        <c:forEach var="hi" begin="0" end="23">
            <option value="${hi}" <c:if test="${h eq hi}"> selected</c:if>>
                <fmt:formatDate value="${zm:getTodayHour(hi, null).time}" pattern="${hourFmt}" timeZone="${tz}"/>
            </option>
        </c:forEach>
    </select>
    <select name="startMinute">
        <c:set var="m" value="${compose.startMinute}"/>
        <option
                <c:if test="${m eq 0}">selected </c:if> value="0">:00
        <option
                <c:if test="${m eq 5}">selected </c:if> value="5">:05
        <option
                <c:if test="${m eq 10}">selected </c:if> value="10">:10
        <option
                <c:if test="${m eq 15}">selected </c:if> value="15">:15
        <option
                <c:if test="${m eq 20}">selected </c:if> value="20">:20
        <option
                <c:if test="${m eq 25}">selected </c:if> value="25">:25
        <option
                <c:if test="${m eq 30}">selected </c:if> value="30">:30
        <option
                <c:if test="${m eq 35}">selected </c:if> value="35">:35
        <option
                <c:if test="${m eq 40}">selected </c:if> value="40">:40
        <option
                <c:if test="${m eq 45}">selected </c:if> value="45">:45
        <option
                <c:if test="${m eq 50}">selected </c:if> value="50">:50
        <option
                <c:if test="${m eq 55}">selected </c:if> value="55">:55
    </select>
    </span>
    </div>
    <div class="table-row cmp_to_row">
        <span class="label table-cell"><fmt:message key="end"/>:</span>
    <span class="table-cell"><input class="Textarea" id="end" type=text size="12" maxlength="20" name="endDate"
                                    value="${fn:escapeXml(compose.endDate)}"> @ <select name="endHour">
        <c:set var="h" value="${compose.endHour}"/>
        <c:forEach var="hi" begin="0" end="23">
            <option value="${hi}" <c:if test="${h eq hi}"> selected</c:if>>
                <fmt:formatDate value="${zm:getTodayHour(hi, null).time}" pattern="${hourFmt}" timeZone="${tz}"/>
            </option>
        </c:forEach>
    </select>
    <select name="endMinute">
        <c:set var="m" value="${compose.endMinute}"/>
        <option
                <c:if test="${m eq 0}">selected </c:if> value="0">:00
        <option
                <c:if test="${m eq 5}">selected </c:if> value="5">:05
        <option
                <c:if test="${m eq 10}">selected </c:if> value="10">:10
        <option
                <c:if test="${m eq 15}">selected </c:if> value="15">:15
        <option
                <c:if test="${m eq 20}">selected </c:if> value="20">:20
        <option
                <c:if test="${m eq 25}">selected </c:if> value="25">:25
        <option
                <c:if test="${m eq 30}">selected </c:if> value="30">:30
        <option
                <c:if test="${m eq 35}">selected </c:if> value="35">:35
        <option
                <c:if test="${m eq 40}">selected </c:if> value="40">:40
        <option
                <c:if test="${m eq 45}">selected </c:if> value="45">:45
        <option
                <c:if test="${m eq 50}">selected </c:if> value="50">:50
        <option
                <c:if test="${m eq 55}">selected </c:if> value="55">:55
    </select>
     </span>
    </div>
</div>
</div>
<c:set var="numCalendars" value="0"/>
    <zm:forEachFolder var="folder">
        <c:if test="${folder.isAppointmentView and folder.isAppointmentMoveTarget}">
            <c:set var="numCalendars" value="${numCalendars+1}"/>
        </c:if>
    </zm:forEachFolder>
    <c:choose>
        <c:when test="${numCalendars gt 1}">
            <div class="View">
            <div class="list-row">
                <span class="label"><fmt:message key="calendar"/>:</span>
                     <span class=""><select name='apptFolderId' id="apptFolderId">
                         <zm:forEachFolder var="folder">
                             <c:if test="${folder.isAppointmentView and folder.isAppointmentMoveTarget }">
                                 <option value="${folder.id}"
                                         <c:if test="${(param.invId ne '' && compose.apptFolderId eq folder.id) || (not empty sessionScope.calendar && sessionScope.calendar.id eq folder.id) || (empty sessionScope.calendar && folder.isCheckedInUI) }">selected='selected'</c:if>/>
                                 ${fn:escapeXml(zm:getFolderName(pageContext, folder.id))}
                             </c:if>
                         </zm:forEachFolder>
                     </select></span></div>
            </div>
        </c:when>
        <%--<c:otherwise>
            &nbsp;
        </c:otherwise>--%>
    </c:choose>
<div class="View">
    <!--<div class="table">-->
    <div class="list-row">
        <span class="label"><fmt:message key="repeat"/>:</span>
        <span class="">
                <input type=radio name='repeatType'
                       <c:if test="${compose.repeatType eq 'NONE'}">checked="checked"</c:if> value="NONE">
                <fmt:message key="recurNone"/>
                <input type=radio id="rpttypeid" name='repeatType' value="BASIC"
                       <c:if test="${compose.repeatType eq 'BASIC'}">checked="checked"</c:if>>
                <select name="repeatBasicType" onchange="document.getElementById('rpttypeid').checked='checked';">
                    <option value="DAILY" <c:if test="${compose.repeatBasicType eq 'DAILY'}">selected </c:if>>
                        <fmt:message
                                key="recurBasicSelectDaily"/></option>
                    <option value="WEEKLY" <c:if test="${compose.repeatBasicType eq 'WEEKLY'}">selected </c:if>>
                        <fmt:message
                                key="recurBasicSelectWeekly"/></option>
                    <option value="MONTHLY" <c:if test="${compose.repeatBasicType eq 'MONTHLY'}">selected </c:if>>
                        <fmt:message key="recurBasicSelectMonthly"/></option>
                    <option value="YEARLY" <c:if test="${compose.repeatBasicType eq 'YEARLY'}">selected </c:if>>
                        <fmt:message
                                key="recurBasicSelectYearly"/></option>
                </select>
        </span>
    </div>
    <div class="">
            <span class="label">
                <input id="allday" type=checkbox name="allDay" <c:if test="${compose.allDay}">checked="checked"</c:if> value="1"> <fmt:message key="allDayEvent"/>
            </span>
            <span class="right">
            <span style="display:none;" id="showHide">
                <a id="showHideLink" href="?&more=1&${pageContext.request.queryString}" onclick="return toggleElem(this,'apt_dtls_div','<fmt:message key="hide"/>','<fmt:message key="more"/>')"><fmt:message
                key="more"/> </a></span></span>
        
    </div>
    </div>    
    
<%--<c:set var="repeat" value="${compose.simpleRecurrence}"/>
<c:if test="${repeat != null && repeat.type != null && !repeat.type.none}">
    <div class="View">
    <div class="table">
    <div class="table-row">
    <span class="label table-cell"><fmt:message
            key="repeats"/> :</span>
        <span class="table-cell">${fn:escapeXml(zm:getRepeatBlurb(repeat,pageContext,mailbox.prefs.timeZone, compose.apptStartCalendar.time))}</span>
    </div>
    </div>
    </div>
</c:if>--%>


<div id="apt_dtls_div">
<div class="View">
    <div class="list-row">
    <span class="label"><fmt:message key="showAs"/>:</span>
        <span>
        <select name="freeBusyStatus" id="showAs">
            <option <c:if test="${compose.freeBusyStatus eq 'F'}">selected </c:if>value="F"><fmt:message key="free"/>
            <option
                    <c:if test="${compose.freeBusyStatus eq 'T'}">selected </c:if> value="T"><fmt:message
                    key="tentative"/>
            <option
                    <c:if test="${compose.freeBusyStatus eq 'B'}">selected </c:if> value="B"><fmt:message key="busy"/>
            <option
                    <c:if test="${compose.freeBusyStatus eq 'O'}">selected </c:if> value="O"><fmt:message
                    key="outOfOffice"/>
        </select>
        </span>
    </div>
    <div>
    <span class="label"><fmt:message key="markAs"/>:</span>
        <span class=""><select name="classProp" id="markAs">
            <option
                    <c:if test="${compose.classProp eq 'PUB'}">selected </c:if> value="PUB"><fmt:message key="public"/>
            <option
                    <c:if test="${compose.classProp eq 'PRI'}">selected </c:if> value="PRI">
                <fmt:message key="private"/>
                <%--<option <c:if test="${compose.classProp eq 'CON'}">selected </c:if> value="CON"><fmt:message key="confidential"/>--%>
        </select></span>
        </div>
</div>
<c:if test="${mailbox.prefs.useTimeZoneListInCalendar or not zm:isSameTimeZone(compose.timeZone, mailbox.prefs.timeZoneCanonicalId)}">
    <c:set var="addedTimeZone" value="true"/>
    <div class="View">
    <div class="list-row">
        <span class="Label"><fmt:message key="timeZonePref"/></span> :
            <span class=""><select name="timeZone" id="timeZone">
                <zm:forEachTimeZone var="tz">
                    <fmt:message var="displayName" bundle='${AjxMsg}' key="${tz.id}"/>
                    <option
                            <c:if test="${compose.timeZone eq tz.id}">selected</c:if>
                            value="${fn:escapeXml(tz.id)}">${fn:escapeXml(displayName)}</option>
                </zm:forEachTimeZone>
            </select>
            </span>
    </div>
        </div>
</c:if>    
<c:if test="${mailbox.features.groupcalendarEnabled}">
    <div class="View">
    <div class="table">
        <div class="table-row">
        <span class="table-cell label"><fmt:message key="attendees"/>:</span>
            <span class="table-cell">
            <div class="ZhAC ZhACTo">
                <input class="Textarea" id="attField" rows="1"
                          name="attendees" value="${fn:escapeXml(compose.attendees)}"/>
                <div class='ZhACCont' id="attContainer" style='width:99%;top:1.5em;'></div>
            </div></span>
    </div>
    </div>
    </div>    
</c:if>

    <div class="View">
        <div class="table">
            <div class="table-row">
                <div class="table-cell">
                    <textarea name="body" id="bodyField" cols="39"
                              class="Textarea">${fn:escapeXml(compose.content)}</textarea>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<div class="table Toolbar">
    <div class="table-row">
        <div class="table-cell">
                    <span class="zo_tb_submit">
                        <a href="${caction}" class="zo_button"><fmt:message key="cancel"/></a>
                    </span>
                    <span class='zo_tb_submit'>
                        <input class="zo_button" name="actionSave" type="submit" value="<fmt:message key="save"/>">
                    </span>
            
        </div>
    </div>
</div>
<input type="hidden" name="apptFolderId" value="${fn:escapeXml(compose.apptFolderId)}"/>
<input type="hidden" name="invId" value="${fn:escapeXml(compose.inviteId)}"/>
<input type="hidden" name="exInvId" value="${fn:escapeXml(compose.exceptionInviteId)}"/>
<input type="hidden" name="useInstance" value="${fn:escapeXml(compose.useInstance ? '1' : '0') }"/>
<input type="hidden" name="instStartTime" value="${fn:escapeXml(compose.instanceStartTime)}"/>
<input type="hidden" name="instDuration" value="${fn:escapeXml(compose.instanceDuration)}"/>
<c:if test="${not addedTimeZone}">
    <input type="hidden" name="timeZone" value="${fn:escapeXml(compose.timeZone)}"/>
</c:if>
<%--<input type="hidden" name="repeatBasicType" value="${fn:escapeXml(compose.repeatBasicType)}"/>--%>
<input type="hidden" name="repeatType" value="${fn:escapeXml(compose.repeatType)}"/>
<input type="hidden" name="repeatDailyInterval" value="${fn:escapeXml(compose.repeatDailyInterval)}"/>
<input type="hidden" name="repeatWeeklyByDay" value="${fn:escapeXml(compose.repeatWeeklyByDay)}"/>
<input type="hidden" name="repeatWeeklyInterval" value="${fn:escapeXml(compose.repeatWeeklyInterval)}"/>
<input type="hidden" name="repeatWeeklySun" value="${fn:escapeXml(compose.repeatWeeklySun) ? '1' : '0'}"/>
<input type="hidden" name="repeatWeeklyMon" value="${fn:escapeXml(compose.repeatWeeklyMon) ? '1' : '0'}"/>
<input type="hidden" name="repeatWeeklyTue" value="${fn:escapeXml(compose.repeatWeeklyTue) ? '1' : '0'}"/>
<input type="hidden" name="repeatWeeklyWed" value="${fn:escapeXml(compose.repeatWeeklyWed) ? '1' : '0'}"/>
<input type="hidden" name="repeatWeeklyThu" value="${fn:escapeXml(compose.repeatWeeklyThu) ? '1' : '0'}"/>
<input type="hidden" name="repeatWeeklyFri" value="${fn:escapeXml(compose.repeatWeeklyFri) ? '1' : '0'}"/>
<input type="hidden" name="repeatWeeklySat" value="${fn:escapeXml(compose.repeatWeeklySat) ? '1' : '0'}"/>
<input type="hidden" name="repeatMonthlyInterval" value="${fn:escapeXml(compose.repeatMonthlyInterval)}"/>
<input type="hidden" name="repeatMonthlyMonthDay" value="${fn:escapeXml(compose.repeatMonthlyMonthDay)}"/>
<input type="hidden" name="repeatMonthlyRelativeInterval"
       value="${fn:escapeXml(compose.repeatMonthlyRelativeInterval)}"/>
<input type="hidden" name="repeatMonthlyRelativeOrd" value="${fn:escapeXml(compose.repeatMonthlyRelativeOrd)}"/>
<input type="hidden" name="repeatMonthlyRelativeDay" value="${fn:escapeXml(compose.repeatMonthlyRelativeDay)}"/>
<input type="hidden" name="repeatYearlyMonthDay" value="${fn:escapeXml(compose.repeatYearlyMonthDay)}"/>
<input type="hidden" name="repeatYearlyMonth" value="${fn:escapeXml(compose.repeatYearlyMonth)}"/>
<input type="hidden" name="repeatYearlyRelativeOrd" value="${fn:escapeXml(compose.repeatYearlyRelativeOrd)}"/>
<input type="hidden" name="repeatYearlyRelativeDay" value="${fn:escapeXml(compose.repeatYearlyRelativeDay)}"/>
<input type="hidden" name="repeatYearlyRelativeMonth" value="${fn:escapeXml(compose.repeatYearlyRelativeMonth)}"/>
<input type="hidden" name="repeatEndType" value="${fn:escapeXml(compose.repeatEndType)}"/>
<input type="hidden" name="repeatEndCount" value="${fn:escapeXml(compose.repeatEndCount)}"/>
<input type="hidden" name="repeatEndDate" value="${fn:escapeXml(compose.repeatEndDate)}"/>
</form>
<script type="text/javascript">
    
    <c:if test="${empty param.more}">
    document.getElementById('apt_dtls_div').style.display = 'none';
    document.getElementById('showHide').style.display = '';
    </c:if>
</script>
<mo:autoComplete>
    initAuto("attField","attContainer");
</mo:autoComplete>
