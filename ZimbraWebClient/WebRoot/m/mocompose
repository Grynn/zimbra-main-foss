<%@ page buffer="8kb" autoFlush="true" %>
<%@ page pageEncoding="UTF-8" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="zm" uri="com.zimbra.zm" %>
<%@ taglib prefix="mo" uri="com.zimbra.mobileclient" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="com.zimbra.i18n" %>
<c:set var="context_url" value="${requestScope.baseURL!=null?requestScope.baseURL:'zmain'}"/>
<c:set var="caction" value="${sessionScope.prevUrl}"/>
<c:choose>
<c:when test="${not empty prevUrl}">
    <c:set var="bt" value="${fn:replace(fn:substringAfter(prevUrl,'?'),'&','|')}"/>
    <c:url var="caction" value='${prevUrl}'/>
</c:when>
<c:when test="${not empty param.bt}">
    <c:set var="bt" value="${param.bt}"/>
    <c:url var="caction" value='${context_url}?${fn:replace(param.bt,"|","&")}'/>
</c:when>
<c:when test="${empty prevUrl  && empty param.bt && not empty header['referer']}">
    <c:set var="caction" value='${header["referer"]}'/>
    <c:set var="bt"
           value="${fn:replace(fn:replace(fn:substringAfter(header['referer'],'?'),'appmsg=messageSent',''),'&','|')}"/>
</c:when>
<c:when test="${empty prevUrl}">
    <c:set var="caction" value='${context_url}'/>
    <c:set var="bt" value="${fn:replace(context_url,'&','|')}"/>
</c:when>
</c:choose>
<c:if test="${!fn:containsIgnoreCase(caction, '_back=1')}">
<c:url value="${caction}" var="caction">
    <c:param name="_back" value="1"/>
</c:url>
</c:if>
<mo:handleError>
    <c:set var="context_url" value="${requestScope.baseURL != null ? requestScope.baseURL : 'zmain'}"/>
    <zm:getMailbox var="mailbox"/>
    <c:choose>
        <c:when test="${not empty mailbox.prefs.locale}">
            <fmt:setLocale value='${mailbox.prefs.locale}' scope='request'/>
        </c:when>
        <c:otherwise>
            <fmt:setLocale value='${pageContext.request.locale}' scope='request'/>
        </c:otherwise>
    </c:choose>
    <fmt:setBundle basename="/messages/ZhMsg" scope="request"/>

    <fmt:message var="title" key="compose"/>
    <zm:composeUploader var="uploader"/>
    <c:set var="compose" value="${uploader.compose}"/>
    <c:choose>
        <c:when test="${!empty param.id or !empty compose.draftId or !empty requestScope.draftid}">
            <c:choose>
                <c:when test="${!empty compose.draftId or !empty requestScope.draftid}">
                    <zm:getMessage var="message"
                                   id="${empty requestScope.draftid ? compose.draftId : requestScope.draftid}"
                                   wanthtml="${false}"/>
                </c:when>
                <c:otherwise>
                    <zm:getMessage var="message" id="${param.id}" part="${param.part}" wanthtml="${false}"/>
                </c:otherwise>
            </c:choose>
        </c:when>
        <c:otherwise>
            <c:set var="message" value="${null}"/>
        </c:otherwise>
    </c:choose>

    <c:choose>
        <c:when test="${empty compose }">
            <zm:messageCompose var="compose" message="${message}" action="${message.isDraft ? 'draft' : param.op}"/>
        </c:when>
        <c:when test="${uploader.isUpload and !empty message}">
            <zm:fixupMessageCompose message="${message}" compose="${compose}"
                                    newattachments="${uploader.compose.hasFileItems or !empty uploader.compose.uploadedAttachment}"/>
        </c:when>
    </c:choose>

</mo:handleError>
<c:set var="title" scope="request" value="${title}"/>
<c:set var="focusField" value="${param.op eq 'reply' or param.op eq 'replyAll' ? 'bodyField' : 'toField'}"/>
<c:set var="nmail" value="st=newmail"/>
<form action="?${nmail}&bt=${bt}" method="post" enctype="multipart/form-data" accept-charset="utf-8" onsubmit="return submitForm(this,'aniframe');">
<input type="hidden" name="crumb" value="${fn:escapeXml(mailbox.accountInfo.crumb)}"/>
<%-- TOP TOOLBAR --%>
<div class="table Toolbar">
    <div class="table-row">
        <div class="table-cell">
        <span class='zo_tb_submit'>
                <a href="${caction}" class="zo_button"><fmt:message key="cancel"/></a>
        </span>
        <span>
           <span class="zo_tb_submit">
                  <input class='zo_button' name="actionDraft" type="submit" value="<fmt:message key="save"/>">
           </span>
           <span class="zo_tb_submit">
                  <input class='zo_button' name="actionSend" type="submit" value="<fmt:message key="send"/>">
           </span>
        </span>
        </div>
    </div>
</div>
<div class="Stripes cmp_container">
<div class="View">
<div class="table cmp_from_to_cc_table">
    <c:if test="${fn:length(mailbox.accountInfo.identities) gt 1 }">
        <div class="table-row cmp_from_row">
            <span class='table-cell label'>
                <label for="fromField"><fmt:message key="fromLabel"/></label>
            </span>
            <span class="table-cell">
                <select id="fromField" name="from" style="width:98% !important;">
                    <c:forEach var="identity" items="${mailbox.accountInfo.identities}">
                        <option
                                <c:if test="${identity.default}">selected='true'</c:if>
                                value="${fn:escapeXml(identity.fromEmailAddress.fullAddressQuoted)}"><%--${fn:escapeXml(identity.name)}::--%>${zm:truncateFixed(fn:escapeXml(identity.fromEmailAddress.fullAddressQuoted),50,true)}</option>
                    </c:forEach>
                </select>
            </span>
         </div>
    </c:if>
    <div class="table-row cmp_to_row">
            <span class='label table-cell'>
                <label for="toField"><fmt:message key="toLabel"/> </label>
                <span><a href="javascript:void(0);" onclick="return toggleElem('cc_bcc_div',this,'&nbsp;','<fmt:message key="ccbcc"/>');"><fmt:message key="ccbcc"/></a></span>
            </span>
            <span class="table-cell">
            <div class="ZhAC ZhACTo">
                <input id="toField" rows="1" autocomplete="OFF" name="to" class="Textarea" value="${fn:escapeXml(compose.to)}"/>
                <div class='ZhACCont' id="toContainer" style='width:99%;top:1.5em;'></div>
            </div>
            </span>
    </div>
    </div>
    <div class="table cmp_from_to_cc_table" id="cc_bcc_div" style="display:none;">
    <div class="table-row cmp_cc_row">
            <span class="label table-cell"><label for="ccField"><fmt:message
                    key="ccLabel"/> </label></span>
            <span class="table-cell">
                <div class="ZhAC ZhACCc">
                    <input class="Textarea" autocomplete="OFF" id="ccField" type="text" value="${fn:escapeXml(compose.cc)}" name="cc">
                    <div class='ZhACCont' id="ccContainer" style='width:99%;'></div>
                </div>
            </span>
    </div>
    <div class="table-row cmp_bcc_row">
            <span class="label table-cell"><label for="bccField"><fmt:message
                    key="bccLabel"/> </label></span>
        <span class="table-cell">
                <div class="ZhAC ZhACBCc">
                    <input class="Textarea" autocomplete="OFF" id="bccField" type="text" value="${fn:escapeXml(compose.bcc)}" name="bcc">
                    <div class='ZhACCont' id="bccContainer" style='width:99%;'></div>
                </div>
            </span>
    </div>
</div>
</div>
<div class="View">
<div class="table">
    <div class="table-row cmp_sub_row">
              <span class='label table-cell'><label for="subjectField"><fmt:message
                      key="subjectLabel"/> </label></span>
               <span class="table-cell"><input class="Textarea" type="text" name="subject"
                             id="subjectField"
                             value="${fn:escapeXml(compose.subject)}"></span>
    </div>    
</div>
</div>    
<c:set var="firstAttachment" value="${true}"/>
<c:if test="${!empty compose.messageAttachments}">
<div class="View">
    <div class="table">
        <c:forEach var="ma" items="${compose.messageAttachments}" varStatus="status">
        <div class="table-row cmp_msg_att_row">
            <span class="table-cell">
                    <c:if test="${firstAttachment}">
                        <%--<mo:img altkey="ALT_ATTACHMENT" src="startup/ImgAttachment.gif"/>--%>
                        <span class="SmlIcnHldr Attachment">&nbsp;</span>
                        <c:set var="firstAttachment" value="${false}"/>
                    </c:if>
                    <c:choose>
                        <c:when test="${empty ma.subject}"><fmt:message var="subj"
                                                                        key="noSubject"/></c:when>
                        <c:otherwise><c:set var="subj"
                                            value="${zm:truncate(ma.subject,100,true)}"/></c:otherwise>
                    </c:choose>
                        ${fn:escapeXml(subj)}
                    <input type="hidden" name="messageAttachment"
                           value="${ma.id}:${fn:escapeXml(ma.subject)}"/>
             </span>
             </c:forEach>
        </div>
    </div>
    </div>
    </c:if>

<c:if test="${!empty compose.originalAttachments}">
<div class="View cmp_att_table">
        <c:forEach var="part" items="${compose.originalAttachments}" varStatus="status">
                <mo:attachment firstAttachment="${firstAttachment}"
                                             url="/service/home/~/?id=${message.id}&part=${part.partName}&auth=co"
                                             displayName="${part.displayName}"
                                             contentType="${part.contentType}"
                                             checked="${compose.checkedAttachmentNames[part.partName]}"
                                             displaySize="${part.displaySize}"
                                             value="${part.partName}" name="originalAttachment"/>
                <c:set var="firstAttachment" value="${false}"/>
        </c:forEach>
</div>
</c:if>

<c:if test="${(!empty param.attachId) and (!empty param.attachUrl) and (!empty param.attachName)}">
    <div class="View cmp_att_table">
        <mo:attachment firstAttachment="${firstAttachment}" url="${param.attachUrl}"
                        displayName="${param.attachName}"
                        checked="true"
                        value="${param.attachId}" name="uploadedAttachment"/>
    </div>
</c:if>
<div class="View cmp_body">
        <textarea class="Textarea"
                  id="bodyField" rows="20" name="body">${fn:escapeXml(compose.content)}</textarea>
        <!-- Shd be removed later-->
        <input type="hidden" id="bodyText" class='MsgCompose' name="bodyText" value=""
                />
 </div>
</div>
<%-- BOTTOM TOOLBAR --%>
<div class="table Toolbar">
    <div class="table-row">
        <div class="table-cell">
        <span class='zo_tb_submit'>
                <a href="${caction}" class="zo_button"><fmt:message key="cancel"/></a>
        </span>
        <span>
           <span class="zo_tb_submit">
                  <input class='zo_button' name="actionDraft" type="submit" value="<fmt:message key="save"/>">
           </span>
           <span class="zo_tb_submit">
                  <input class='zo_button' name="actionSend" type="submit" value="<fmt:message key="send"/>">
           </span>
        </span>
        </div>
    </div>
</div>
<input type="hidden" name="sendUID" value="${fn:escapeXml(compose.sendUID)}"/>
<input type="hidden" name="replyto" value="${fn:escapeXml(compose.replyTo)}"/>
<input type="hidden" name="from" value="${fn:escapeXml(compose.from)}"/>
<input type="hidden" name="inreplyto" value="${fn:escapeXml(compose.inReplyTo)}"/>
<input type="hidden" name="messageid" value="${fn:escapeXml(compose.messageId)}"/>
<input type="hidden" name="compNum" value="${fn:escapeXml(compose.compNum)}"/>
<input type="hidden" name="instCompNum" value="${fn:escapeXml(compose.instanceCompNum)}"/>
<input type="hidden" name="replytype" value="${fn:escapeXml(compose.replyType)}"/>
<input type="hidden" name="inviteReplyVerb" value="${fn:escapeXml(compose.inviteReplyVerb)}"/>
<input type="hidden" name="inviteReplyInst" value="${fn:escapeXml(compose.inviteReplyInst)}"/>
<input type="hidden" name="inviteReplyAllDay" value="${fn:escapeXml(compose.inviteReplyAllDay)}"/>

<c:if test="${message.isDraft}">
    <input type="hidden" name="draftid" value="${message.id}"/>
</c:if>
</form>
<mo:autoComplete>
    initAuto("toField","toContainer");
    initAuto("ccField","ccContainer");
    initAuto("bccField","bccContainer");
</mo:autoComplete>
