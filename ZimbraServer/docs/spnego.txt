I. SPNEGO SSO

   The SPNEGO SSO feature allows Windows domain users to enter their Zimbra mailbox without 
   having to re-authenticate themselves to Zimbra by entering their Zimbra credentials.
    
   Microsoft's Active Directory/Kerberos implementation is the single authentication store.
   
   It is essential that a user must logon to a Windows 2000 domain, local logons will not work.
   
   Supported browsers:
     - Internet Explorer 6.0 or later
     - Firefox 3.0 or later
     - Chrome
     
   
   A high level description of the Authentication flow:
   (see http://msdn.microsoft.com/en-us/library/ms995329.aspx for more information)
   
   - User logon to a Windows domain.
   - The logged-on user must have acquired Kerberos credentials from the domain.
   - The logged-on user then attempts to access Zimbra. 
   - Zimbra is configured to redirect the request to a URL under SPNEGO protection. 
   - The Zimbra server asks for authentication with Kerberos (by using SPNEGO). 
   - The client obtains a ticket for the requested service from the KDC and presents these credentials back to Zimbra server.
   - The Zimbra server extracts the user's credentials and authenticates the request and identifies the user.
   - The request is then redirected to Zimbra's preauth servlet with all required preauth parameters for the identified user.
   - The Zimbra preauth servlet verifies the preauth parameters and redirect the user into the Zimbra mail page.


II. Zimbra UI Flow

1. user login to Windows as a domain user or a local user

2. user browses to the regular Zimbra entry URL, e.g. http://dogfood.zimbra.com

3. a domain(e.g. zimbra.com) gets resolved by virtual host name (dogfood.zimbra.com)

4. zimbraWebClientLoginURL on domain redirects user to a preauth jsp under a spnego protected webapp/URL.

5. spnego authentication happens (by jetty)

6. if spnego auth succeeds, goto 7, if failed goto step 13
   Windows local user will fail.
   Windows domain user will pass, in the rare case when spnego auth fails for a domain user, the flow goes to step 13.

7. user is redirected to the Zimbra preauth servlet

8. Zimbra preauth happens and succeeds

9. user gets redirected to the Zimbra mail app, all is well.

10. user clicks on the "logout" button, and gets redirected to the zimbraWebClientLogOutURL 
    configured on the domain.

11. the logout URL points to the page UI, which has a "Launch" button.  The only action user can take is clicking 
    on the "Launch" button.

12. user clicks on "Launch", and gets redirected to the regular Zimbra entry page (goto step 2)
 
13. (spnego auth failed) user is redirected to the error URL, which we set to /zimbra/?ignoreLoginURL=1
    User will be redirected to the regular Zimbra entry page (i.e. login.jsp), with query parameter "ignoreLoginURL=1".

14. zimbraWebClientLoginURL will be ignored in login.jsp, because of the "?igoreLoginURL=1", and user will see the Zimbra user/pass page.

15. user enters his Zimbra user/pass to login, all is well.


III. Configuration
======================================
1. Create and Set Up the Keytab File
======================================

On the Windows AD domain controller:

(A) Create an Active Directory service account.
    This is the account you use to generate the keytab.
       
    - programs -> Administrative Tools -> Active Directory Users and Computers
    
    - right click on "Users" under the domain
    
    - new -> User 
    
    - Fill in the following:
          Full name: {a display name}

          User Logon Name: HTTP/{zimbra mailbox server name} (the domain is automatically filled)
          (Note: this is the value to be set for the zimbraSpnegoAuthTargetName server attribute in LDAP.)

          User Logon Name (pre-Windows 2000): {AD user name} 
          (Note: this is the name you use for the -mapUser {AD-user} parameter in the setspn and ktpass commands (see below).)

      e.g.
          Full name: zimbra-dogfood

          User Logon Name: HTTP/dogfood.zimbra.com

          User Logon Name (pre-Windows 2000): zimbra-dogfood 
      
    - click on Next

    - enter and confirm the password (e.g. test123)
      (Note: this is the password you use for the -pass {AD-user-password} parameter in the ktpass command (see below))
      
      check "password never expires"
      
    - click on "Next"
    
    - click on "Finish" to create the user.   


(B) Add the Service Principal Names (SPN) directory property for an Active Directory service account. 

    setspn -A {Service-Principal-Name-for-the-http-server} {AD-user}
    
    e.g.
    - list registered SPNs (there is none)
      C:\>setspn -L zimbra-dogfood
      Registered ServicePrincipalNames for CN=zimbra-dogfood,CN=Users,DC=vmware,DC=com:

    - add SPN for the service account
      C:\>setspn -A HTTP/dogfood.zimbra.com zimbra-dogfood
      Registering ServicePrincipalNames for CN=zimbra-dogfood,CN=Users,DC=vmware,DC=com HTTP/dogfood.zimbra.com
      Updated object

    - list registered SPNs (should see the one we just added)
      C:\>setspn -L zimbra-dogfood
      Registered ServicePrincipalNames for CN=zimbra-dogfood,CN=Users,DC=vmware,DC=com:
      HTTP/dogfood.zimbra.com


(C) Create the keytab file
   
    ktpass -out {keytab-file-to-produce} -princ {Service-Principal-Name}@{the-kerberos-realm} -mapUser {AD-user} -mapOp set -pass {AD-user-password} -crypto RC4-HMAC-NT -pType KRB5_NT_PRINCIPAL
    
    e.g.
    The following will create jetty.keytab file under c:\Temp\spnego:
    
    C:\>ktpass -out c:\Temp\spnego\jetty.keytab -princ HTTP/dogfood.zimbra.com@VMWARE.COM -mapUser zimbra-dogfood -mapOp set -pass test123 -crypto RC4-HMAC-NT -pType KRB5_NT_PRINCIPAL
    Targeting domain controller: test-dc.vmware.com
    Using legacy password setting method
    Successfully mapped HTTP/dogfood.zimbra.com to zimbra-dogfood.
    Key created.
    Output keytab to c:\Temp\spnego\jetty.keytab:
    Keytab version: 0x502
    keysize 71 HTTP/dogfood.zimbra.com@VMWARE.COM ptype 1 (KRB5_NT_PRINCIPAL) vno3 etype 0x17 (RC4-HMAC) keylength 16 (0xc383f6a25f1e195d5aef495c980c2bfe)
    
    
(D) Place the Keytab File on Zimbraserver   
    copy jetty.keytab created in step (C) to the zimbra server (e.g. dogfood.zimbra.com) under /opt/zimbra/jetty/etc.
    
    Note: Do not rename the keytab file, the name(jetty.keytab) is referenced from various configuration files.


Repeat steps (A) to (D) for each zimbra server(e.g. catfood.zimbra.com, corp.zimbra.com).


=====================
2. Configure Zimbra
=====================
- For production system, do 2.1, 2.2, 2.3.

- For dev system: do "ant spnego-dev-deploy" under ZimbraServer.


2.1. Configure Global Config
----------------------------
We support only one REALM per Zimbra installation.

Modify the following global config attributes with "zmprov mcf" command.

zimbraSpnegoAuthEnabled     : TRUE
                              e.g. zmprov mcf zimbraSpnegoAuthEnabled TRUE

zimbraSpnegoAuthErrorURL    : URL to redirect users to on spnego auth failure 
                              Setting it to "/zimbra/?ignoreLoginURL=1"
                              will redirect user to the regular Zimbra login page, where 
                              user will be prompted or the zimbra user name and password.
                              e.g. zmprov mcf zimbraSpnegoAuthErrorURL '/zimbra/?ignoreLoginURL=1'                    
                     
zimbraSpnegoAuthRealm       : the kerberos realm in the domain controller
                              e.g. zmprov mcf zimbraSpnegoAuthRealm VMWARE.COM


2.2. Configure Servers
----------------------
On each zimbra server, modify the following global config attributes with "zmprov ms" command.

zimbraSpnegoAuthTargetName  : the name for the service user in III. 1. (A), 
                              e.g. zmprov ms dogfood.zimbra.com zimbraSpnegoAuthTargetName HTTP/dogfood.zimbra.com
                                   zmprov ms catfood.zimbra.com zimbraSpnegoAuthTargetName HTTP/catfood.zimbra.com

zimbraSpnegoAuthPrincipal   : {zimbraSpnegoAuthTargetName}@{zimbraSpnegoAuthRealm}
                              e.g. zmprov ms dogfood.zimbra.com zimbraSpnegoAuthPrincipal HTTP/dogfood.zimbra.com@VMWARE.COM
                                   zmprov ms catfood.zimbra.com zimbraSpnegoAuthPrincipal HTTP/catfood.zimbra.com@VMWARE.COM
  

2.3. Configure Domain
---------------------
(A) Setup preauth for the domain.
    - Generate a preauth key using zmprov gdpak
      zmprov gdpak {domain}
      e.g.
      zmprov gdpak zimbra.com
      preAuthKey: 4e2816f16c44fab20ecdee39fb850c3b0bb54d03f1d8e073aaea376a4f407f0c

    - Set the preauth key on the domain
      mprov md {domain} zimbraPreAuthKey {the-preauth-key}
      e.g.
      mprov md zimbra.com zimbraPreAuthKey 4e2816f16c44fab20ecdee39fb850c3b0bb54d03f1d8e073aaea376a4f407f0c
      
    - Modify /opt/zimbra/jetty/webapps/spnego/spnego_preauth.jsp with the preauth key.
      edit the spnego_preauth.jsp
      replace the text REPLACE-ME-WITH-THE-PREAUTH-KEY with the real preauth key.  

    *** Note: spnego_preauth.jsp will be overwritten after each upgrade.  So this step has to be performed 
              after each upgrade. 
              

(B) Setup kerberos Realm for the domain
    zmprov md {domain} zimbraAuthKerberos5Realm {kerberos-realm}

    {kerberos-realm} should be the same realm set in global config attribute zimbraSpnegoAuthRealm
    
    e.g. 
    zmprov md zimbra.com zimbraAuthKerberos5Realm VMWARE.COM
    
    
(C) Setup virtual host for the domain
    zmprov md {domain} +zimbraVirtualHostname {virtual-hostname-1} +zimbraVirtualHostname {virtual-hostname-2}
    
    virtual-hostname-* are the hostnames you can browse to for the Zimbra WEB UI.
    e.g.
    zmprov md zimbra.com +zimbraVirtualHostname dogfood.zimbra.com +zimbraVirtualHostname catfood.zimbra.com
    
    
(D) Setup login URL and UAs allowed for the login URL on the domain
    (This is the URL to be redirected to when user browses to the regular Zimbra login page.) 
    zmprov md {domain} zimbraWebClientLoginURL '../../spnego/spnego_preauth.jsp'
    
    (Following will honor zimbraWebClientLoginURL only for Firefox/IE/Chrome on Windows)
    zmprov md {domain} +zimbraWebClientLoginURLAllowedUA '.*Windows NT.*Firefox/3.*'
    zmprov md {domain} +zimbraWebClientLoginURLAllowedUA '.*MSIE.*Windows NT.*'
    zmprov md {domain} +zimbraWebClientLoginURLAllowedUA '.*Windows NT.*Chrome.*'
    
    
(E) Setup logout URL and UAs allowed for the logout URL on the domain
    (This is the URL to be redirected to when user clicks on "logout".)
    zmprov md {domain} zimbraWebClientLogoutURL '../?sso=1'
    
    (Following will honor zimbraWebClientLogoutURL only for Firefox/IE/Chrome on Windows)
    zmprov md {domain} +zimbraWebClientLogoutURLAllowedUA '.*Windows NT.*Firefox/3.*'
    zmprov md {domain} +zimbraWebClientLogoutURLAllowedUA '.*MSIE.*Windows NT.*'
    zmprov md {domain} +zimbraWebClientLogoutURLAllowedUA '.*Windows NT.*Chrome.*'



===========================
3. Configure Your Browser
===========================
Firefox:
* browse to about:config and agree to the warnings
* search through to find the 'network' settings
** set network.negotiate-auth.delegation-uris to http://,https://
** set network.negotiate-auth.trusted-uris to http://,https://

IE and Chrome:
* Tools -> Options -> Security -> Local Intranet -> Sites
** make sure everything is checked here
* Tools -> Options -> Security -> Local Intranet -> Sites -> Advanced
** add url to server (http:// and/or https://) making sure to use the hostname
* Tools -> Options -> Security -> Local Intranet -> Sites -> Advanced -> Close
* Tools -> Options -> Security -> Local Intranet -> Sites -> Ok
* Tools -> Options -> Advanced -> Security (in the checkbox list)
** locate and check 'Enable Integrated Windows Authentication'
* Tools -> Options -> Advanced -> Security -> Ok
* close IE


================
4. Test it out
================
- On a Windows box, login to the domain as a domain user.
  
  Your ticket as a domain user will be saved on the computer.
  Ths token will be picked up by the spnego aware browser and send in 
  the Authorization header to zimbra server.
  
- Browse to the regualr ZWC entry page:
  e.g. http://dogfood.zimbra.com
  
- You should be redirected to your inbox, without being prompted for user/pass.

  
What happens behind the scene in ZCS server:
  - A domain gets resolved by the virtual host name setting.
    (zimbraVirtualHostname on domain)
  
  - The request gets redirected to the login URL on the domain.
    (zimbraWebClientLoginURL on domain)
  
  - The login URL points to a spnego protected URL.
    (/spnego/spnego_preauth.jsp)
  
  - spnego auth happens
  
  - if spnego auth fails, user will be redirected to an error URL.
    (zimbraSpnegoAuthErrorURL on global config)
    
  - if spnego auth succeeds, zimbra preauth sequence will happen, 
    user will be redirected to the preauth servlet and then finally landed 
    on the mailbox inbox.
    

==========
Appendix
==========
Scripts to setup spnego on dogfood.zimbra.com and catfood.zimbra.com:

zmprov mcf zimbraSpnegoAuthEnabled TRUE
zmprov mcf zimbraSpnegoAuthErrorURL '/zimbra/?ignoreLoginURL=1' 
zmprov mcf zimbraSpnegoAuthRealm VMWARE.COM

zmprov ms dogfood.zimbra.com zimbraSpnegoAuthTargetName HTTP/dogfood.zimbra.com
zmprov ms catfood.zimbra.com zimbraSpnegoAuthTargetName HTTP/catfood.zimbra.com
zmprov ms dogfood.zimbra.com zimbraSpnegoAuthPrincipal HTTP/dogfood.zimbra.com@VMWARE.COM
zmprov ms catfood.zimbra.com zimbraSpnegoAuthPrincipal HTTP/catfood.zimbra.com@VMWARE.COM

Do III 2.3 (A) to setup preauth key on the domain
mprov md zimbra.com zimbraPreAuthKey {preauth-key}

zmprov md zimbra.com zimbraAuthKerberos5Realm VMWARE.COM
zmprov md zimbra.com +zimbraVirtualHostname dogfood.zimbra.com +zimbraVirtualHostname catfood.zimbra.com
zmprov md zimbra.com zimbraWebClientLoginURL '../../spnego/spnego_preauth.jsp'
zmprov md zimbra.com +zimbraWebClientLoginURLAllowedUA '.*Windows NT.*Firefox/3.*'
zmprov md zimbra.com +zimbraWebClientLoginURLAllowedUA '.*MSIE.*Windows NT.*'
zmprov md zimbra.com +zimbraWebClientLoginURLAllowedUA '.*Windows NT.*Chrome.*'
zmprov md zimbra.com zimbraWebClientLogoutURL '../?sso=1'
zmprov md zimbra.com +zimbraWebClientLogoutURLAllowedUA '.*Windows NT.*Firefox/3.*'
zmprov md zimbra.com +zimbraWebClientLogoutURLAllowedUA '.*MSIE.*Windows NT.*'
zmprov md zimbra.com +zimbraWebClientLogoutURLAllowedUA '.*Windows NT.*Chrome.*'
