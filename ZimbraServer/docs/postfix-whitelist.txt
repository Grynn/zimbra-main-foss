Example restricting who can send mail to a distribution list.

Please read documentation for postfix configuration parameters
smtpd_recipient_restrictions and smtpd_restriction_classes:

    http://www.postfix.org/postconf.5.html#smtpd_recipient_restrictions
    http://www.postfix.org/postconf.5.html#smtpd_restriction_classes

Please also read a postfix README that gives an example of how to
protect an alias (ie, distribution list) from external mail.

    http://www.postfix.org/RESTRICTION_CLASS_README.html

Expanding on that example, here is how you would apply such
restrictions from a list of users in LDAP.

This restriction is subject to SMTP sender spoofing.

You will have to make postfix changes in all your postfix instances
(Install may or may not have multiple postfix instances).

(1) Create a distribution list 'all@example.com' and add two addresses
    to it.

        $ lqprov cd example.com
        $ lqprov cdl all@example.com
        $ lqprov adlm all@example.com jack@example.com
        $ lqprov adlm all@example.com jill@example.com

(2) We need an access table that will restrict senders to this mailing
    list.  See http://www.postfix.org/access.5.html.  Create one as a
    postfix ldap table:

        $ cat /opt/liquid/conf/restrict_all.cf
        server_host = ldap.example.com
        server_port = 389
        search_base =
        query_filter = (&(liquidMailAddress=all@example.com)(liquidMailForwardingAddress=%s))
        result_attribute = liquidMailAddress
        result_filter = OK
        version = 3

    You can get valid values from server_host and server_port from
    ldapvalias.cf or ldaptransport.cf which also define postfix ldap
    tables.

    With liquid ldap schema, this query_filter returns an entry only
    if the sender email address (%s) is in the mailing list
    'all@example.com'.  No one other than a distribution list can
    have an liquidMailAddress attribute that is the address of the
    distribution list.

    We ignore result_attribute, but we have to specify one anyway to
    distinguish finding an entry versus not.

(3) Test access table created above.

         $ postmap -q jack@example.com ldap:/opt/liquid/conf/restrict_all.cf
         OK
         $ postmap -q nope@example.com ldap:/opt/liquid/conf/restrict_all.cf
         $

    Note that jack@example.com is in this distribution list and you
    get OK, and you get no output for someone who is not in said
    distribution list.

(4) Create a table that says to apply a 'restrict_all' restriction
    class to recipient 'all@example.com':

         $ cat /opt/liquid/conf/restrict
         all@example.com          restrict_all

         $ postmap /opt/liquid/conf/restrict

         $ postmap -q all@example.com /opt/liquid/conf/restrict
         restrict_all

         $ postmap -q nope@example.com /opt/liquid/conf/restrict
         $

(5) Modify main.cf to start using this access table.  The restriction
    table has to be before permit_mynetworks or local users can
    violate this restriction.

        smtpd_recipient_restrictions =
                <stuff deleted>
                hash:/opt/liquid/conf/restrict,
                permit_mynetworks,
                <stuff deleted>

(6) Create the 'restrict_all' smtp class in postfix main.cf, by adding
    the lines:

           smtpd_restriction_classes = restrict_all 

           restrict_all = check_sender_access ldap:/opt/liquid/conf/restrict_all.cf, reject

    You can have multiple restriction classes, eg, one for each
    distribution list that you want to restrict - they are space
    separated in smtpd_restriction_classes parameter.

(7) Make postfix aware of config update.

         $ postfix reload

(8) Test your changes with an smtp client (such as telnet) that will
    let you spoof 'rcpt to:'.

You could (should?) use 'postconf -e' to make changes to main.cf.

In summary, a table in smtpd_recipient_restrictions defines a
'restriction classes' on a 'recipient' (in this case, recipient is a
distribution list).  The 'restriction class' is defined by listing it
in 'smtpd_restriction_classes' and defining a config parameter
('restrict_all', in this example) with the name of the restriction
class; the value of this config parameter specifies an 'access table'
of 'senders' allowed to send mail this 'recipient.'

