
# __LDAP

ldap: $(RPM_DIR) ldap_stage $(BUILD_ROOT)/zimbraldap.spec
	(cd $(LDAP_DEST_ROOT); \
		rpmbuild  --target i386 --quiet --define '_rpmdir $(BUILD_ROOT)' \
		--buildroot=$(LDAP_DEST_ROOT) -bb $(BUILD_ROOT)/zimbraldap.spec )

$(BUILD_ROOT)/zimbraldap.spec:
	cp $(RPM_CONF_DIR)/Spec/Scripts/zimbraldap.pre $(BUILD_ROOT)
	cp $(RPM_CONF_DIR)/Spec/Scripts/zimbraldap.post $(BUILD_ROOT)
	cat $(RPM_CONF_DIR)/Spec/zimbraldap.spec | \
		sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
		-e 's/@@RELEASE@@/$(RELEASE)/' \
		-e 's/^Copyright:/$(RPMCOPYRIGHTSTR):/' \
		-e '/^%pre$$/ r zimbraldap.pre' \
		-e '/^%post$$/ r zimbraldap.post' > $(BUILD_ROOT)/zimbraldap.spec
	rm -f zimbraldap.pre
	rm -f zimbraldap.post
	echo "%attr(-, zimbra, zimbra) /opt/zimbra/openldap-$(LDAP_VERSION)" >> \
		$(BUILD_ROOT)/zimbraldap.spec

ldap_stage: $(LDAP_COMPONENTS)

$(LDAP_DEST_DIR):
	mkdir -p $@

$(LDAP_DEST_DIR)/$(LDAP_DIR): $(LDAP_DEST_DIR) 
	@echo "*** Creating openldap"
	(cd $(LDAP_DEST_DIR); tar xzf $(LDAP_SOURCE).tgz;)
	cp $(SERVICE_DIR)/conf/ldap/DB_CONFIG \
		$(LDAP_DEST_DIR)/$(LDAP_DIR)/var/openldap-data
	cp $(SERVICE_DIR)/conf/ldap/slapd.conf.production \
		$(LDAP_DEST_DIR)/$(LDAP_DIR)/etc/openldap/slapd.conf
	cp $(SERVICE_DIR)/conf/ldap/amavisd.schema \
		$(LDAP_DEST_DIR)/$(LDAP_DIR)/etc/openldap/schema
	cp $(SERVICE_DIR)/conf/ldap/zimbra.schema \
		$(LDAP_DEST_DIR)/$(LDAP_DIR)/etc/openldap/schema
	cp $(SERVICE_DIR)/conf/ldap/zimbra.ldif \
		$(LDAP_DEST_DIR)/$(LDAP_DIR)/etc/openldap/zimbra.ldif
	cp $(SERVICE_DIR)/conf/ldap/zimbra_mimehandlers.ldif \
		$(LDAP_DEST_DIR)/$(LDAP_DIR)/etc/openldap/zimbra_mimehandlers.ldif
	cp $(SERVICE_DIR)/conf/ldap/widgets.ldif \
		$(LDAP_DEST_DIR)/$(LDAP_DIR)/etc/openldap/widgets.ldif
