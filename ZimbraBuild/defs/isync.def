# __ISync

ISYNC_PACKAGING_OPTIONS ?= -build -v -p $(PACKAGE_DIR)/$(CUR_PACKAGE_NAME).$(PACKAGE_EXT) -proj $(ISYNC_DEST_ROOT)/Zimbra.pmproj

isync: CUR_DEST_ROOT := $(ISYNC_DEST_ROOT) 
isync: CUR_PACKAGE_NAME := zimbra-isync
isync: CUR_PACKAGING_OPTIONS := $(ISYNC_PACKAGING_OPTIONS)
isync: $(PACKAGE_DIR) isync_stage $(CUR_PACKAGE_NAME)-$(RELEASE).dmg

isync_stage: $(ISYNC_DEST_DIR)/Zimbra.prefPane $(ISYNC_DEST_ROOT)/InstallerResources $(ISYNC_DEST_ROOT)/Zimbra.pmproj

$(ISYNC_DEST_DIR):
	mkdir -p $@

$(ISYNC_DEST_DIR)/Zimbra.prefPane: $(ISYNC_DEST_DIR) $(ISYNC_DIR)/build/Deployment/Zimbra.prefPane
	cp -r $(ISYNC_DIR)/build/Deployment/Zimbra.prefPane $@

$(ISYNC_DIR)/build/Deployment/Zimbra.prefPane:
	(cd $(ISYNC_DIR); xcodebuild -configuration Deployment)

$(ISYNC_DEST_ROOT)/Zimbra.pmproj:
	cp $(ISYNC_DIR)/Zimbra.pmproj $@

$(ISYNC_DEST_ROOT)/InstallerResources: $(ISYNC_DIR)/build/Deployment/Zimbra.prefPane
	mkdir -p $@
	cp $(ISYNC_DIR)/InstallerResources/* $@
	cp $(ISYNC_DIR)/build/Deployment/ZimbraUpdater $@/preflight

$(PACKAGE_DIR)/$(CUR_PACKAGE_NAME).$(PACKAGE_EXT):
	(cd $(CUR_DEST_ROOT);  $(PACKAGING_COMMAND) $(CUR_PACKAGING_OPTIONS) )

$(CUR_PACKAGE_NAME)-$(RELEASE).dmg: $(PACKAGE_DIR)/$(CUR_PACKAGE_NAME).$(PACKAGE_EXT) 
	rm -rf $(ISYNC_DEST_ROOT)/tmp
	mkdir $(ISYNC_DEST_ROOT)/tmp
	cp -R $(PACKAGE_DIR)/$(CUR_PACKAGE_NAME).$(PACKAGE_EXT) $(ISYNC_DEST_ROOT)/tmp
	hdiutil create -srcfolder $(ISYNC_DEST_ROOT)/tmp -volname $(CUR_PACKAGE_NAME)-$(VERSION_TAG).$(BUILD_PLATFORM) $(PACKAGE_DIR)/$(CUR_PACKAGE_NAME)-$(VERSION_TAG).$(BUILD_PLATFORM).dmg

