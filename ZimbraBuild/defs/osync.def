# __OSync

OSYNC_VERSION_TAG := $(MAJOR).$(MINOR).$(BUILDNUM)
OSYNC_RAGEL_VERSION	:= 6.7
OSYNC_BOOST_VERSION	:= 1.47.0
OSYNC_OPENSSL_VERSION	:= 1.0.0e
osync: VERSION_TAG := $(MAJOR).$(MINOR).$(MICRO)_$(BUILDNUM).MACOSX_UB
osync: CUR_DEST_ROOT := $(OSYNC_DEST_ROOT) 
osync: CUR_PACKAGE_NAME := zimbra-osync
osync: $(PACKAGE_DIR) $(OSYNC_DIR)/Info.plist osync_stage $(CUR_PACKAGE_NAME)-$(RELEASE).dmg

osync_stage: $(OSYNC_DEST_DIR)/Zimbra.prefPane $(OSYNC_DEST_ROOT)/InstallerResources $(OSYNC_DEST_ROOT)/Zimbra.pmproj

$(OSYNC_DEST_DIR):
	mkdir -p $@

$(OSYNC_DEST_DIR)/osync: $(OSYNC_DEST_DIR) $(OSYNC_DIR)/build

$(OSYNC_DIR)/build:
	(cd $(OSYNC_DIR); \
	xcodebuild -project Msync_osx.xcodeproj -configuration Debug -scheme "Build DMG" BOOST_ROOT=/opt/octopus/boost-$(OSYNC_BOOST_VERSION)/ OPENSSL_ROOT=/opt/octopus/openssl-$(OSYNC_OPENSSL_VERSION) PATH=${PATH}:/opt/octopus/ragel-$(OSYNC_RAGEL_VERSION)/bin VERSIONER_PERL_PREFER_32_BIT=yes build

$(OSYNC_DEST_ROOT)/Zimbra.pmproj:
	plutil -convert xml1 $(OSYNC_DIR)/Zimbra.pmproj -o $(OSYNC_DIR)/Zimbra.plist
	sed -i -e 's/0.9.19/$(OSYNC_VERSION_TAG)/g' $(OSYNC_DIR)/Zimbra.plist
	plutil -convert binary1 $(OSYNC_DIR)/Zimbra.plist -o $@
	cp $(OSYNC_DIR)/License.rtf $(OSYNC_DEST_ROOT)

$(OSYNC_DEST_ROOT)/InstallerResources: $(OSYNC_DIR)/build/Deployment/Zimbra.prefPane
	mkdir -p $@
	cp $(OSYNC_DIR)/InstallerResources/* $@

$(OSYNC_DIR)/Info.plist: force
	touch $@
	chmod 744 $@
	sed -e "s/@@OSYNC_VERSION_TAG@@/$(OSYNC_VERSION_TAG)/" -e "s/@@VERSION_TAG@@/$(VERSION_TAG)/" $(OSYNC_DIR)/Info-production.plist > $@ 

